<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TRACK">
<meta name="theme-color" content="#0a0a0b">
<link rel="manifest" href="manifest.json">
<title>TRACK — Package Tracker</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0b;--surface:#111113;--surface2:#1a1a1e;--border:#2a2a30;
  --accent:#f0e040;--accent2:#40e0d0;--text:#e8e8ec;--muted:#666672;
  --red:#ff4455;--green:#44dd88;--orange:#ff9933;--blue:#4499ff;
  --font:Helvetica,Arial,sans-serif;
}
html{color-scheme:dark;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(240,224,64,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(240,224,64,.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
.container{max-width:980px;margin:0 auto;padding:0 20px;position:relative;z-index:1}
button{-webkit-tap-highlight-color:transparent;user-select:none}
header{padding:28px 0 14px;border-bottom:1px solid var(--border)}
.header-row{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap}
.logo{font-weight:800;font-size:11px;letter-spacing:6px;color:var(--accent);text-transform:uppercase;margin-bottom:4px}
header h1{font-weight:800;font-size:clamp(26px,5vw,48px);line-height:.9;letter-spacing:-2px}
header h1 span{color:var(--accent)}
header p{margin-top:6px;color:var(--muted);font-size:11px;letter-spacing:1px}
.header-actions{display:flex;gap:6px;align-items:center;padding-bottom:2px;flex-wrap:wrap}
.hdr-btn{padding:5px 11px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-size:10px;cursor:pointer;transition:all .15s;letter-spacing:1px;white-space:nowrap;font-family:var(--font)}
.hdr-btn:hover{border-color:var(--accent);color:var(--accent)}
.hdr-btn.on{border-color:var(--accent2);color:var(--accent2);background:rgba(64,224,208,.08)}
.stats-bar{display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-top:none}
.stat-cell{background:var(--surface);padding:9px 12px;text-align:center;cursor:pointer;transition:background .15s}
.stat-cell:hover{background:var(--surface2)}
.stat-num{font-size:20px;font-weight:800;line-height:1}
.stat-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px}
.stat-cell.overdue .stat-num{color:var(--red)}
.stat-cell.transit .stat-num{color:var(--blue)}
.stat-cell.out .stat-num{color:var(--orange)}
.stat-cell.delivered .stat-num{color:var(--green)}
.stat-cell.total .stat-num{color:var(--accent)}
.banner{display:none;padding:7px 14px;font-size:11px;letter-spacing:1px;align-items:center;gap:10px;border-top:none}
.banner.show{display:flex}
.banner.overdue-b{background:rgba(255,68,85,.08);border:1px solid rgba(255,68,85,.3);color:var(--red)}
.banner.today-b{background:rgba(68,221,136,.07);border:1px solid rgba(68,221,136,.3);color:var(--green);border-top:none}
.banner a{text-decoration:underline;cursor:pointer;color:inherit}
.main-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:22px;overflow-x:auto}
.main-tab{padding:12px 18px;background:transparent;border:none;border-bottom:3px solid transparent;color:var(--muted);font-family:var(--font);font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .15s;margin-bottom:-1px;white-space:nowrap}
.main-tab:hover{color:var(--text)}
.main-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-badge{display:inline-block;background:var(--accent2);color:var(--bg);font-size:9px;font-weight:700;border-radius:10px;padding:1px 6px;margin-left:5px;vertical-align:middle}
.add-form-wrap{margin-bottom:22px}
.form-toggle-bar{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);cursor:pointer;user-select:none;transition:all .15s}
.form-toggle-bar:hover{border-color:var(--accent)}
.form-toggle-label{font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-weight:700;flex:1}
.form-toggle-arrow{color:var(--muted);font-size:13px;transition:transform .2s}
.form-toggle-arrow.open{transform:rotate(90deg)}
.add-form{background:var(--surface);border:1px solid var(--border);border-top:none;padding:20px;position:relative;display:none}
.add-form.open{display:block}
.add-form::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--accent)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.form-grid.three{grid-template-columns:1fr 1fr 1fr}
.form-grid.four{grid-template-columns:1fr 1fr 1fr 1fr}
.field{display:flex;flex-direction:column;gap:5px}
label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
input,select,textarea{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:13px;padding:9px 12px;outline:none;transition:border-color .2s;width:100%;color-scheme:dark}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
select option{background:var(--bg);color:var(--text)}
.date-wrap{position:relative;display:flex;align-items:stretch}
.date-wrap input[type="date"]{flex:1;cursor:pointer;padding-right:42px}
.date-wrap input[type="date"]::-webkit-calendar-picker-indicator{position:absolute;right:0;top:0;bottom:0;width:40px;height:100%;opacity:0;cursor:pointer;margin:0;padding:0}
.date-btn{position:absolute;right:0;top:0;bottom:0;width:40px;background:var(--surface2);border:none;border-left:1px solid var(--border);color:var(--text);font-size:15px;pointer-events:none;display:flex;align-items:center;justify-content:center}
.quick-add-row{display:flex;gap:7px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-top:none;align-items:stretch}
.quick-add-row input{flex:1;font-size:12px;padding:8px 11px}
.qa-btn{padding:8px 16px;background:var(--accent);color:var(--bg);border:none;font-family:var(--font);font-weight:700;font-size:11px;letter-spacing:1px;cursor:pointer;white-space:nowrap}
.qa-btn:hover{background:#fff}
.qa-hint{font-size:10px;color:var(--muted);letter-spacing:1px;padding:5px 14px 8px;background:var(--surface);border:1px solid var(--border);border-top:none}
.carrier-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(84px,1fr));gap:7px;margin-bottom:12px}
.carrier-btn{padding:8px 5px;background:var(--bg);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;transition:all .15s;text-align:center;letter-spacing:1px;display:flex;flex-direction:column;align-items:center;gap:4px}
.carrier-btn img{width:40px;height:18px;object-fit:contain;filter:grayscale(1) brightness(.45);transition:filter .2s}
.carrier-btn:hover img,.carrier-btn.selected img{filter:grayscale(0) brightness(1)}
.carrier-btn:hover,.carrier-btn.selected{border-color:var(--accent);color:var(--accent)}
.carrier-btn.selected{background:rgba(240,224,64,.07)}
.btn{background:var(--accent);color:var(--bg);border:none;font-family:var(--font);font-weight:700;font-size:13px;letter-spacing:2px;text-transform:uppercase;padding:12px 26px;cursor:pointer;transition:all .15s;width:100%}
.btn:hover{background:#fff;transform:translateY(-1px)}
.tag-row{display:flex;flex-wrap:wrap;gap:5px;align-items:center;margin-bottom:8px}
.tag-chip{padding:3px 10px;border:1px solid var(--border);font-size:10px;letter-spacing:1px;cursor:pointer;transition:all .15s;background:var(--bg);color:var(--muted)}
.tag-chip:hover{border-color:var(--accent2);color:var(--accent2)}
.tag-chip.selected{background:var(--accent2);color:var(--bg);border-color:var(--accent2);font-weight:700}
.tag-input-wrap{display:flex;gap:6px}
.tag-input-wrap input{flex:1;max-width:150px;padding:5px 9px;font-size:11px}
.tag-add-btn{padding:5px 10px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer}
.tag-add-btn:hover{border-color:var(--accent2);color:var(--accent2)}
.po-chips-row{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:5px;min-height:4px}
.po-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:rgba(240,224,64,.07);border:1px solid rgba(240,224,64,.25);color:var(--accent);font-size:10px;letter-spacing:1px}
.po-chip-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:0 1px;line-height:1}
.po-chip-del:hover{color:var(--red)}
.attach-btn{padding:7px 13px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;transition:all .15s}
.attach-btn:hover{border-color:var(--accent2);color:var(--accent2)}
.photo-preview{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px}
.photo-thumb-wrap{position:relative;display:inline-block}
.photo-thumb{width:48px;height:48px;object-fit:cover;border:1px solid var(--border);cursor:pointer;display:block}
.photo-thumb:hover{border-color:var(--accent2)}
.thumb-del{position:absolute;top:-5px;right:-5px;width:16px;height:16px;background:var(--red);border:none;color:#fff;font-size:10px;cursor:pointer;border-radius:50%;line-height:16px;text-align:center;padding:0}
.scan-btn{padding:8px 13px;background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);font-family:var(--font);font-size:11px;letter-spacing:1px;cursor:pointer;display:flex;align-items:center;gap:5px;white-space:nowrap;transition:all .15s}
.scan-btn:hover{background:rgba(64,224,208,.1)}
#scanOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:3000;flex-direction:column;align-items:center;justify-content:center;gap:14px}
#scanOverlay.open{display:flex}
#scanVideo{width:min(400px,90vw);border:2px solid var(--accent2);border-radius:4px}
.scan-close{padding:9px 24px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:12px;cursor:pointer;letter-spacing:1px}
.scan-hint{font-size:11px;color:var(--muted);letter-spacing:1px;text-align:center}
.list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px}
.list-title{font-weight:700;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--muted)}
.list-controls{display:flex;gap:7px;align-items:center;flex-wrap:wrap}
.count-badge{background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-size:11px;padding:4px 10px;letter-spacing:1px}
.sort-select{padding:5px 9px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;letter-spacing:1px;cursor:pointer}
.sort-select:focus{border-color:var(--accent);outline:none}
.view-toggle{display:flex}
.view-btn{padding:5px 9px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-size:14px;cursor:pointer;transition:all .15s;font-family:var(--font)}
.view-btn:first-child{border-right:none}
.view-btn.active,.view-btn:hover{background:rgba(240,224,64,.07);border-color:var(--accent);color:var(--accent)}
.filter-bar{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.filter-tab{padding:4px 10px;background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all .15s}
.filter-tab:hover{color:var(--text);border-color:var(--text)}
.filter-tab.active{background:var(--surface2);color:var(--text);border-color:var(--text)}
.filter-tab.tag-filter.active{background:rgba(64,224,208,.12);color:var(--accent2);border-color:var(--accent2)}
.filter-sep{width:1px;height:18px;background:var(--border);margin:0 3px;flex-shrink:0}
.search-row{display:flex;gap:7px;align-items:stretch;margin-bottom:8px;flex-wrap:wrap}
.search-wrap{flex:1;min-width:180px;position:relative;display:flex;align-items:center}
.search-icon{position:absolute;left:10px;font-size:15px;color:var(--muted);pointer-events:none;line-height:1}
.search-input{width:100%;padding:8px 32px 8px 30px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:12px;outline:none;transition:border-color .2s}
.search-input:focus{border-color:var(--accent)}
.search-input::placeholder{color:var(--muted)}
.search-clear{position:absolute;right:8px;background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;padding:2px 4px;line-height:1}
.search-clear:hover{color:var(--text)}
.filter-select{padding:8px 10px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:11px;outline:none;cursor:pointer;min-width:120px}
.filter-select:focus{border-color:var(--accent)}
.filter-reset-btn{padding:8px 12px;background:rgba(255,68,85,.1);border:1px solid rgba(255,68,85,.3);color:var(--red);font-family:var(--font);font-size:10px;letter-spacing:1px;cursor:pointer;white-space:nowrap;transition:all .15s}
.filter-reset-btn:hover{background:var(--red);color:#fff}
mark{background:rgba(240,224,64,.25);color:var(--accent);border-radius:2px}
.bulk-bar{display:none;align-items:center;gap:8px;padding:7px 12px;background:rgba(64,224,208,.07);border:1px solid rgba(64,224,208,.25);margin-bottom:8px;flex-wrap:wrap}
.bulk-bar.show{display:flex}
.bulk-count{font-size:11px;color:var(--accent2);letter-spacing:1px;flex:1}
.bulk-btn{padding:4px 12px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;letter-spacing:1px;cursor:pointer;transition:all .15s}
.bulk-btn:hover{border-color:var(--accent2);color:var(--accent2)}
.bulk-btn.danger:hover{border-color:var(--red);color:var(--red)}
.pkg-checkbox{width:15px;height:15px;cursor:pointer;accent-color:var(--accent2);flex-shrink:0}
.package-card{background:var(--surface);border:1px solid var(--border);margin-bottom:8px;overflow:hidden;animation:slideIn .2s ease;position:relative;transition:transform .25s,opacity .25s}
@keyframes slideIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
.package-card.today-pkg{border-color:rgba(68,221,136,.45);box-shadow:0 0 0 1px rgba(68,221,136,.12)}
.package-card.today-pkg::after{content:'TODAY';position:absolute;top:0;right:0;background:var(--green);color:var(--bg);font-size:8px;font-weight:800;letter-spacing:2px;padding:3px 8px;z-index:2}
.card-header{display:flex;align-items:stretch;cursor:pointer;position:relative;transition:background .15s}
.card-header:hover{background:rgba(240,224,64,.02)}
.edit-hint{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:9px;letter-spacing:1px;color:var(--accent);text-transform:uppercase;opacity:0;transition:opacity .2s;pointer-events:none;background:rgba(10,10,11,.85);padding:3px 7px;border:1px solid rgba(240,224,64,.2);white-space:nowrap}
.package-card:hover .edit-hint{opacity:1}
.carrier-logo-stripe{width:64px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 5px;flex-shrink:0;border-right:1px solid var(--border);gap:4px}
.carrier-logo-stripe img{width:44px;height:21px;object-fit:contain}
.carrier-abbr{font-weight:800;font-size:8px;letter-spacing:2px;text-transform:uppercase;text-align:center}
.c-ups .carrier-logo-stripe{background:#130c00}.c-ups .carrier-abbr{color:#ffb800}
.c-fedex .carrier-logo-stripe{background:#0e0520}.c-fedex .carrier-abbr{color:#9b59ff}
.c-usps .carrier-logo-stripe{background:#051228}.c-usps .carrier-abbr{color:#4499ff}
.c-dhl .carrier-logo-stripe{background:#140e00}.c-dhl .carrier-abbr{color:#ffcc00}
.c-amazon .carrier-logo-stripe{background:#0a1605}.c-amazon .carrier-abbr{color:#88cc44}
.c-ontrac .carrier-logo-stripe{background:#160808}.c-ontrac .carrier-abbr{color:#ff6644}
.c-lasership .carrier-logo-stripe{background:#061420}.c-lasership .carrier-abbr{color:#44aadd}
.c-estes .carrier-logo-stripe{background:#0e1500}.c-estes .carrier-abbr{color:#99dd33}
.c-xpo .carrier-logo-stripe{background:#1a0000}.c-xpo .carrier-abbr{color:#ff3333}
.c-saia .carrier-logo-stripe{background:#001220}.c-saia .carrier-abbr{color:#3399ff}
.c-tforce .carrier-logo-stripe{background:#100008}.c-tforce .carrier-abbr{color:#cc44ff}
.c-other .carrier-logo-stripe{background:#0d0d18}.c-other .carrier-abbr{color:var(--accent2)}
.tinted.c-ups{background:linear-gradient(90deg,#180e00,var(--surface) 280px)}
.tinted.c-fedex{background:linear-gradient(90deg,#110625,var(--surface) 280px)}
.tinted.c-usps{background:linear-gradient(90deg,#071530,var(--surface) 280px)}
.tinted.c-dhl{background:linear-gradient(90deg,#1a1000,var(--surface) 280px)}
.tinted.c-amazon{background:linear-gradient(90deg,#0c1e00,var(--surface) 280px)}
.tinted.c-ontrac{background:linear-gradient(90deg,#1e0808,var(--surface) 280px)}
.tinted.c-xpo{background:linear-gradient(90deg,#200000,var(--surface) 280px)}
.tinted.c-other{background:linear-gradient(90deg,#0d1018,var(--surface) 280px)}
.card-main{flex:1;padding:12px 70px 12px 14px;min-width:0}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:6px}
.package-name{font-weight:700;font-size:14px}
.tracking-num{font-size:10px;color:var(--muted);letter-spacing:1px;margin-top:2px;word-break:break-all}
.card-tags{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:5px}
.card-tag{padding:2px 7px;background:rgba(64,224,208,.1);border:1px solid rgba(64,224,208,.25);color:var(--accent2);font-size:9px;letter-spacing:1px;text-transform:uppercase}
.dest-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;font-size:9px;letter-spacing:1px;text-transform:uppercase;border:1px solid}
.dest-dropship{border-color:rgba(255,153,51,.4);color:var(--orange);background:rgba(255,153,51,.08)}
.dest-office{border-color:rgba(68,153,255,.4);color:var(--blue);background:rgba(68,153,255,.08)}
.dest-custom{border-color:rgba(64,224,208,.3);color:var(--accent2);background:rgba(64,224,208,.06)}
.status-pill{padding:3px 9px;font-size:10px;letter-spacing:1px;text-transform:uppercase;font-weight:700;white-space:nowrap;flex-shrink:0;border:1px solid}
.card-meta{display:flex;gap:11px;flex-wrap:wrap;margin-bottom:5px}
.meta-item{font-size:10px;color:var(--muted)}
.meta-item strong{color:var(--text);font-weight:400}
.overdue-flag{color:var(--red);font-size:9px;letter-spacing:1px;padding:1px 5px;border:1px solid rgba(255,68,85,.35);background:rgba(255,68,85,.08)}
.delivered-delta{font-size:9px;color:var(--green);letter-spacing:1px}
.note-preview{margin-top:4px}
.note-entry{display:flex;gap:8px;font-size:10px;padding:2px 0}
.note-time{color:var(--muted);font-size:9px;flex-shrink:0}
.note-text{color:var(--text)}
.timeline-toggle{background:none;border:none;color:var(--accent);font-family:var(--font);font-size:10px;cursor:pointer;letter-spacing:1px;padding:0;margin-top:3px}
.timeline-toggle:hover{color:var(--text)}
.card-photos{display:flex;gap:5px;flex-wrap:wrap;padding:7px 14px 7px 78px;border-top:1px solid var(--border);background:var(--bg)}
.card-photo-thumb{width:48px;height:48px;object-fit:cover;border:1px solid var(--border);cursor:pointer;transition:transform .15s}
.card-photo-thumb:hover{transform:scale(1.06);border-color:var(--accent2)}
.timeline{display:none;border-top:1px solid var(--border);padding:12px 14px 12px 78px;background:var(--bg)}
.timeline.open{display:block}
.timeline-add{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.timeline-add input,.timeline-add select{flex:1;min-width:90px;font-size:11px;padding:6px 8px}
.btn-sm{padding:6px 12px;background:var(--accent);color:var(--bg);border:none;font-family:var(--font);font-weight:700;font-size:10px;letter-spacing:1px;cursor:pointer;white-space:nowrap}
.btn-sm:hover{background:var(--text)}
.events-list{display:flex;flex-direction:column}
.event-item{display:grid;grid-template-columns:70px 17px 1fr;gap:0 8px;align-items:start;padding:3px 0}
.event-time{font-size:9px;color:var(--muted);padding-top:2px;text-align:right}
.event-dot-col{display:flex;flex-direction:column;align-items:center}
.event-dot{width:9px;height:9px;border-radius:50%;border:2px solid;flex-shrink:0;margin-top:2px}
.event-line{width:2px;flex:1;min-height:14px;margin-top:2px;background:var(--border)}
.event-item:last-child .event-line{display:none}
.event-content{padding-bottom:3px}
.event-status-label{font-size:11px;font-weight:700;color:var(--text)}
.event-location{font-size:10px;color:var(--muted)}
.event-note{font-size:10px;color:var(--muted);font-style:italic}
.card-actions{display:flex;gap:5px;padding:7px 14px 7px 78px;border-top:1px solid var(--border);background:var(--surface);flex-wrap:wrap;align-items:center}
.action-btn{padding:4px 10px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;letter-spacing:1px;cursor:pointer;transition:all .15s}
.action-btn:hover{border-color:var(--accent);color:var(--accent)}
.action-btn.arch:hover{border-color:var(--accent2);color:var(--accent2)}
.action-btn.del:hover{border-color:var(--red);color:var(--red)}
.action-btn.dup:hover{border-color:var(--orange);color:var(--orange)}
.track-link{font-size:10px;color:var(--accent2);text-decoration:none;letter-spacing:1px;margin-left:auto}
.track-link:hover{text-decoration:underline}
.pkg-list.compact .package-card{margin-bottom:2px}
.pkg-list.compact .carrier-logo-stripe{width:50px;padding:6px 4px}
.pkg-list.compact .carrier-logo-stripe img{width:34px;height:15px}
.pkg-list.compact .carrier-abbr{font-size:7px}
.pkg-list.compact .card-main{padding:7px 60px 7px 12px}
.pkg-list.compact .package-name{font-size:12px}
.pkg-list.compact .tracking-num,.pkg-list.compact .card-tags,.pkg-list.compact .timeline-toggle,.pkg-list.compact .note-preview{display:none}
.pkg-list.compact .card-meta{margin-bottom:0}
.pkg-list.compact .meta-item{font-size:9px}
.pkg-list.compact .card-actions{padding-left:62px;padding-top:4px;padding-bottom:4px}
.pkg-list.compact .action-btn{padding:3px 9px;font-size:9px}
.pkg-list.compact .card-photos,.pkg-list.compact .timeline{display:none!important}
.pkg-list.compact .edit-hint{display:none}
.pkg-list.compact .today-pkg::after{font-size:7px;padding:2px 5px}
.s-pending{background:rgba(102,102,114,.1);color:var(--muted);border-color:var(--border)}
.s-transit{background:rgba(68,153,255,.1);color:var(--blue);border-color:rgba(68,153,255,.35)}
.s-outdelivery{background:rgba(255,153,51,.1);color:var(--orange);border-color:rgba(255,153,51,.35)}
.s-delivered{background:rgba(68,221,136,.1);color:var(--green);border-color:rgba(68,221,136,.35)}
.s-exception{background:rgba(255,68,85,.1);color:var(--red);border-color:rgba(255,68,85,.35)}
.s-return{background:rgba(240,224,64,.1);color:var(--accent);border-color:rgba(240,224,64,.35)}
.dot-pending{border-color:var(--muted)}
.dot-transit{border-color:var(--blue);background:rgba(68,153,255,.3)}
.dot-outdelivery{border-color:var(--orange);background:rgba(255,153,51,.3)}
.dot-delivered{border-color:var(--green);background:rgba(68,221,136,.3)}
.dot-exception{border-color:var(--red);background:rgba(255,68,85,.3)}
.dot-return{border-color:var(--accent);background:rgba(240,224,64,.3)}
.empty-state{text-align:center;padding:44px 20px;color:var(--muted)}
.empty-state .icon{font-size:36px;margin-bottom:10px;opacity:.3}
.empty-state h3{font-size:15px;margin-bottom:5px;color:var(--border)}
.empty-state p{font-size:11px}
#carrierDetect{display:none;font-size:10px;letter-spacing:1px;padding:4px 7px;margin-top:2px;border-left:3px solid var(--accent);color:var(--accent);background:rgba(240,224,64,.06)}
#calView{display:none}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.cal-title{font-weight:800;font-size:20px;letter-spacing:-.5px}
.cal-nav-btn{padding:7px 15px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:11px;cursor:pointer;transition:all .15s}
.cal-nav-btn:hover{border-color:var(--accent);color:var(--accent)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border)}
.cal-day-header{background:var(--surface2);padding:7px 4px;text-align:center;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
.cal-cell{background:var(--surface);min-height:90px;padding:5px;position:relative}
.cal-cell.other-month{background:var(--bg);opacity:.4}
.cal-cell.today{background:#131316}
.cal-cell.today .cal-day-num{color:var(--accent);font-weight:700}
.cal-cell.drag-over{background:rgba(240,224,64,.06);outline:2px dashed var(--accent);outline-offset:-2px}
.cal-day-num{font-size:10px;color:var(--muted);margin-bottom:3px;font-weight:700}
.cal-pkg{padding:4px 6px;margin-bottom:3px;font-size:9px;border-left:3px solid;background:var(--surface2);cursor:grab;user-select:none;line-height:1.3}
.cal-pkg:active{cursor:grabbing}
.cal-pkg.dragging{opacity:.3}
.cal-pkg.today-cal{border-color:var(--green)!important;background:rgba(68,221,136,.07)}
.cal-pkg.touch-dragging-clone{position:fixed;pointer-events:none;z-index:9999;opacity:.9;box-shadow:0 8px 24px rgba(0,0,0,.6);min-width:130px;transform:rotate(2deg) scale(1.05);border:1px solid var(--accent)}
.cal-pkg-name{font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cal-pkg.s-pending{border-color:var(--muted);color:var(--muted)}
.cal-pkg.s-transit{border-color:var(--blue);color:var(--blue)}
.cal-pkg.s-outdelivery{border-color:var(--orange);color:var(--orange)}
.cal-pkg.s-delivered{border-color:var(--green);color:var(--green)}
.cal-pkg.s-exception{border-color:var(--red);color:var(--red)}
.cal-pkg.s-return{border-color:var(--accent);color:var(--accent)}
.cal-hint{margin-top:10px;font-size:10px;color:var(--muted);letter-spacing:1px}
#historyView{display:none}
.package-card.archived{border-style:dashed;opacity:.75}
.archived-when{font-size:9px;color:var(--accent2);letter-spacing:1px;padding:3px 14px 3px 78px;border-bottom:1px solid rgba(64,224,208,.15);background:rgba(64,224,208,.04)}
.action-btn.restore:hover{border-color:var(--green);color:var(--green)}
.action-btn.perm-del:hover{border-color:var(--red);color:var(--red);background:rgba(255,68,85,.06)}
.sync-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:7px 14px;background:var(--surface);border:1px solid var(--border);border-top:none;font-size:10px;letter-spacing:1px}
.sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sync-dot.ok{background:var(--green);box-shadow:0 0 5px var(--green)}
.sync-dot.err{background:var(--red);box-shadow:0 0 5px var(--red)}
.sync-dot.syncing{background:var(--orange);animation:sblink .8s infinite}
.sync-dot.off{background:var(--border)}
@keyframes sblink{0%,100%{opacity:1}50%{opacity:.25}}
.sync-status-text{color:var(--muted);flex:1;min-width:100px}
.sync-btn{padding:4px 11px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-family:var(--font);font-size:10px;letter-spacing:1px;cursor:pointer;transition:all .15s;white-space:nowrap}
.sync-btn:hover{border-color:var(--accent2);color:var(--accent2)}
.sync-btn.hi{border-color:var(--accent);color:var(--accent)}
.sync-btn.hi:hover{background:var(--accent);color:var(--bg)}
.sync-btn:disabled{opacity:.35;cursor:not-allowed}
.sync-panel{display:none;background:var(--surface);border:1px solid var(--border);border-top:none;padding:18px 22px}
.sync-panel.open{display:block}
.sync-panel h3{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--accent2);margin-bottom:12px}
.sync-step{display:flex;gap:10px;margin-bottom:11px;align-items:flex-start}
.sync-step-num{width:20px;height:20px;border-radius:50%;background:var(--accent2);color:var(--bg);font-weight:800;font-size:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.sync-step-body{flex:1;font-size:11px;color:var(--muted);line-height:1.6}
.sync-step-body strong{color:var(--text)}
.sync-step-body a{color:var(--accent2)}
.sync-url-row{display:flex;gap:7px;align-items:stretch;margin-top:12px}
.sync-url-row input{flex:1;font-size:11px;padding:8px 10px}
.sync-save-btn{padding:8px 15px;background:var(--accent);color:var(--bg);border:none;font-family:var(--font);font-weight:700;font-size:11px;letter-spacing:1px;cursor:pointer}
.sync-save-btn:hover{background:#fff}
.sync-clear-btn{padding:8px 12px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer}
.sync-clear-btn:hover{border-color:var(--red);color:var(--red)}
.gas-code{background:var(--bg);border:1px solid var(--border);padding:10px 13px;font-family:monospace;font-size:10px;color:var(--accent);line-height:1.7;margin:8px 0;overflow-x:auto;white-space:pre}
.copy-code-btn{padding:4px 10px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer}
.copy-code-btn:hover{border-color:var(--accent);color:var(--accent)}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2000;align-items:flex-start;justify-content:center;padding:32px 14px 14px;overflow-y:auto}
.modal-overlay.open{display:flex;animation:mFadeIn .17s ease}
@keyframes mFadeIn{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--surface);border:1px solid var(--border);width:100%;max-width:760px;position:relative;animation:mSlideUp .18s ease;flex-shrink:0}
@keyframes mSlideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:1}
.modal-title{font-weight:800;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--accent)}
.modal-close{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;line-height:1;padding:2px 6px}
.modal-close:hover{color:var(--text)}
.modal-body{padding:18px}
.modal-footer{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding-top:4px}
.modal-cancel{padding:10px 17px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:11px;cursor:pointer;letter-spacing:1px}
.modal-cancel:hover{color:var(--text)}
.modal-section{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--accent2);padding-bottom:6px;border-bottom:1px solid var(--border);margin:18px 0 10px}
.settings-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);gap:12px}
.settings-label{font-size:12px;color:var(--text)}
.settings-sub{font-size:10px;color:var(--muted);margin-top:2px}
.toggle-btn{padding:4px 12px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;transition:all .15s}
.toggle-btn.on{border-color:var(--green);color:var(--green);background:rgba(68,221,136,.08)}
.toggle-btn:hover{border-color:var(--accent);color:var(--accent)}
.dest-item{display:flex;align-items:center;gap:7px;padding:6px 0;border-bottom:1px solid var(--border)}
.dest-item-name{flex:1;font-size:12px;color:var(--text)}
.dest-del{padding:3px 9px;background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer}
.dest-del:hover{border-color:var(--red);color:var(--red)}
.dest-add-row{display:flex;gap:7px;margin-top:9px}
.dest-add-row input{flex:1;font-size:12px}
.dest-add-btn{padding:8px 14px;background:var(--accent2);color:var(--bg);border:none;font-family:var(--font);font-weight:700;font-size:10px;cursor:pointer}
.status-label-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.status-label-row{display:flex;flex-direction:column;gap:4px}
.status-label-row label{font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase}
.status-label-row input{font-size:11px;padding:6px 9px}
.template-item{display:flex;align-items:center;gap:9px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all .15s;margin-bottom:5px}
.template-item:hover{border-color:var(--accent)}
.template-name{font-size:12px;font-weight:700;flex:1;color:var(--text)}
.template-meta{font-size:10px;color:var(--muted)}
.template-del{padding:3px 9px;background:var(--surface);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer}
.template-del:hover{border-color:var(--red);color:var(--red)}
.note-history-list{max-height:160px;overflow-y:auto;margin-top:7px}
.note-h-entry{display:flex;gap:9px;padding:4px 0;border-bottom:1px solid var(--border)}
.note-h-time{font-size:9px;color:var(--muted);flex-shrink:0;padding-top:1px}
.note-h-text{font-size:11px;color:var(--text)}
.note-add-row{display:flex;gap:7px}
.note-add-row input{flex:1;font-size:12px}
.kb-grid{display:grid;grid-template-columns:auto 1fr;gap:7px 16px;align-items:center}
.kb-key{display:inline-block;padding:3px 7px;background:var(--surface2);border:1px solid var(--border);border-bottom-width:2px;font-size:11px;color:var(--text);letter-spacing:1px;border-radius:3px;white-space:nowrap}
.kb-desc{font-size:11px;color:var(--muted)}
.notif-row{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);margin-bottom:10px}
.notif-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.notif-dot.on{background:var(--green);box-shadow:0 0 5px var(--green)}
.notif-dot.off{background:var(--border)}
.notif-label{font-size:11px;color:var(--muted);flex:1}
.notif-enable-btn{padding:5px 12px;background:var(--surface);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;transition:all .15s}
.notif-enable-btn:hover{border-color:var(--green);color:var(--green)}
#lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:4000;align-items:center;justify-content:center;cursor:zoom-out}
#lightbox.open{display:flex}
#lightbox img{max-width:92vw;max-height:90vh;border:1px solid var(--border)}
.lb-close{position:absolute;top:14px;right:14px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:17px;cursor:pointer;padding:4px 10px}
body.light{--bg:#f4f4f0;--surface:#fff;--surface2:#eaeae6;--border:#d0d0cc;--text:#1a1a1e;--muted:#888890}
@media(max-width:640px){
  .form-grid,.form-grid.three,.form-grid.four{grid-template-columns:1fr}
  .cal-cell{min-height:70px}
  .card-actions,.timeline,.card-photos,.archived-when{padding-left:14px}
  .action-btn{padding:9px 12px;font-size:11px}
  .filter-tab{padding:7px 9px}
  .main-tab{padding:10px 11px;font-size:10px}
  .search-row{flex-direction:column}
  .filter-select{width:100%}
  .container{padding-bottom:env(safe-area-inset-bottom,14px)}
  .stats-bar{grid-template-columns:repeat(3,1fr)}
  .header-actions{gap:4px}
  .hdr-btn{padding:4px 8px;font-size:9px}
  .status-label-grid{grid-template-columns:1fr}
}
@media(display-mode:standalone){
  header{padding-top:max(28px,env(safe-area-inset-top,28px))}
  body{padding-bottom:env(safe-area-inset-bottom,0)}
}
footer{margin-top:44px;padding:14px 0 30px;border-top:1px solid var(--border);text-align:center;color:var(--muted);font-size:10px;letter-spacing:1px}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="header-row">
    <div>
      <div class="logo">Logistics Dashboard</div>
      <h1>TRACK<span>.</span></h1>
      <p>Manual package tracker — all shipments in one place</p>
    </div>
    <div class="header-actions">
      <button class="hdr-btn" id="themeBtn" onclick="toggleTheme()">&#9728; Theme</button>
      <button class="hdr-btn" id="colorBtn" onclick="toggleColorRows()">&#127912; Colors</button>
      <button class="hdr-btn" onclick="openSettings()">&#9881; Settings</button>
      <button class="hdr-btn" onclick="openTemplates()">&#128203; Templates</button>
      <button class="hdr-btn" onclick="openKb()">&#9000; Keys</button>
    </div>
  </div>
</header>
<div class="stats-bar">
  <div class="stat-cell total" onclick="resetAllFilters()"><div class="stat-num" id="statTotal">0</div><div class="stat-lbl">Total</div></div>
  <div class="stat-cell transit" onclick="filterByStat('transit')"><div class="stat-num" id="statTransit">0</div><div class="stat-lbl">In Transit</div></div>
  <div class="stat-cell out" onclick="filterByStat('outdelivery')"><div class="stat-num" id="statOut">0</div><div class="stat-lbl">Out for Del.</div></div>
  <div class="stat-cell delivered" onclick="filterByStat('delivered')"><div class="stat-num" id="statDelivered">0</div><div class="stat-lbl">Delivered</div></div>
  <div class="stat-cell overdue" onclick="filterOverdue()"><div class="stat-num" id="statOverdue">0</div><div class="stat-lbl">Overdue</div></div>
</div>
<div class="banner overdue-b" id="overdueBanner">&#9888; <span id="overdueText"></span> &mdash; <a onclick="filterOverdue()">Show overdue</a></div>
<div class="banner today-b" id="todayBanner">&#128236; <span id="todayText"></span> &mdash; <a onclick="filterToday()">Show arriving today</a></div>
<div class="sync-bar">
  <div class="sync-dot off" id="syncDot"></div>
  <span class="sync-status-text" id="syncStatusText">Google Sheets not configured</span>
  <button class="sync-btn" id="syncNowBtn" onclick="syncNow()" disabled style="background:rgba(64,224,208,.1);border-color:var(--accent2);color:var(--accent2);font-weight:700">&#8645; Sync Now</button>
  <button class="sync-btn" id="syncPullBtn" onclick="syncPull(true)" disabled>&#8595; Pull</button>
  <button class="sync-btn" id="syncPushBtn" onclick="syncPush(true)" disabled>&#8593; Push</button>
  <button class="sync-btn hi" onclick="toggleSyncPanel()">&#9881; Setup</button>
</div>
<div class="sync-panel" id="syncPanel">
  <h3>Google Sheets Sync</h3>
  <div class="sync-step"><div class="sync-step-num">1</div><div class="sync-step-body"><strong>Create a Google Sheet</strong> at <a href="https://sheets.new" target="_blank">sheets.new</a>.</div></div>
  <div class="sync-step"><div class="sync-step-num">2</div><div class="sync-step-body"><strong>Extensions &rarr; Apps Script.</strong> Paste the script below:<br><br><button class="copy-code-btn" onclick="copyGasCode()">&#128203; Copy Script</button><div class="gas-code" id="gasCode">const SN='Packages';
function doGet(e){
  const ss=SpreadsheetApp.getActiveSpreadsheet();
  const sh=ss.getSheetByName(SN)||ss.insertSheet(SN);
  const d=sh.getDataRange().getValues();
  if(d.length<=1)return ok({packages:[],tags:[],ts:0});
  const h=d[0],rows=d.slice(1).map(r=>{
    const o={};h.forEach((k,i)=>o[k]=r[i]);
    ['events','tags','pos','noteHistory','attachments'].forEach(k=>{try{o[k]=JSON.parse(o[k]||'[]');}catch(ex){o[k]=[];}});
    return o;
  });
  let meta={ts:0};
  try{const m=ss.getSheetByName('Meta');if(m){const raw=m.getRange('A1').getValue();if(raw)meta=JSON.parse(raw);}}catch(ex){}
  return ok({packages:rows,...meta});
}
function doPost(e){
  const ss=SpreadsheetApp.getActiveSpreadsheet();
  const sh=ss.getSheetByName(SN)||ss.insertSheet(SN);
  let b;
  try{b=JSON.parse(e.postData.contents);}catch(ex){return oops('Bad JSON: '+ex);}
  return write(ss,sh,b);
}
function write(ss,sh,b){
  const H=['id','name','tracking','carrier','sender','destination','expectedDate','status','notes','noteHistory','pos','tags','addedAt','events','attachments'];
  sh.clearContents();sh.appendRow(H);
  (b.packages||[]).forEach(p=>sh.appendRow(H.map(k=>{const v=p[k];return(Array.isArray(v)||(v&&typeof v==='object'))?JSON.stringify(v):(v!=null?v:'');})));
  const m=ss.getSheetByName('Meta')||ss.insertSheet('Meta');
  const ts=Date.now();
  m.getRange('A1').setValue(JSON.stringify({tags:b.tags||[],customDests:b.customDests||[],customStatusLabels:b.customStatusLabels||{},templates:b.templates||[],ts}));
  return ok({saved:(b.packages||[]).length,ts});
}
function ok(d){return ContentService.createTextOutput(JSON.stringify({ok:true,...d})).setMimeType(ContentService.MimeType.JSON);}
function oops(m){return ContentService.createTextOutput(JSON.stringify({ok:false,error:m})).setMimeType(ContentService.MimeType.JSON);}</div></div></div>
  <div class="sync-step"><div class="sync-step-num">3</div><div class="sync-step-body"><strong>Deploy &rarr; New deployment.</strong> Type: Web app. Execute as: Me. Access: Anyone. Copy URL.</div></div>
  <div class="sync-step"><div class="sync-step-num">4</div><div class="sync-step-body"><strong>Paste URL below and save.</strong></div></div>
  <div class="sync-url-row">
    <input type="text" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/&hellip;/exec">
    <button class="sync-save-btn" onclick="saveScriptUrl()">Save</button>
    <button class="sync-clear-btn" onclick="clearScriptUrl()">Clear</button>
  </div>
</div>
<div class="main-tabs">
  <button class="main-tab active" onclick="switchView('packages',this)">&#128230; Packages</button>
  <button class="main-tab" onclick="switchView('calendar',this)">&#128197; Calendar</button>
  <button class="main-tab" onclick="switchView('history',this)" id="historyTab">&#128193; History</button>
</div>
<div id="pkgView">
  <div class="add-form-wrap">
    <div class="form-toggle-bar" onclick="toggleAddForm()">
      <div class="form-toggle-label">+ Add Package</div>
      <div class="form-toggle-arrow" id="addFormArrow">&#9658;</div>
    </div>
    <div class="quick-add-row">
      <input type="text" id="qaName" placeholder="Package name&hellip;" onkeydown="if(event.key==='Enter')quickAdd()">
      <input type="text" id="qaTracking" placeholder="Tracking # (optional)&hellip;" oninput="qaDetect(this.value)" onkeydown="if(event.key==='Enter')quickAdd()" autocomplete="off" spellcheck="false">
      <button class="scan-btn" onclick="openScanner('qa')" title="Scan barcode">&#128247; Scan</button>
      <button class="qa-btn" onclick="quickAdd()">&#9889; Quick Add</button>
    </div>
    <div class="qa-hint">Quick Add uses defaults from Settings &mdash; open &#9658; above for all fields &mdash; &#128247; tap to scan a barcode</div>
    <div class="add-form" id="addForm">
      <div class="form-grid">
        <div class="field"><label>Package Name</label><input type="text" id="pkgName" placeholder="e.g. MacBook Pro, Chair&hellip;"></div>
        <div class="field"><label>Tracking Number</label>
          <div style="display:flex;gap:7px;align-items:flex-start">
            <div style="flex:1">
              <input type="text" id="trackNum" placeholder="1Z999AA10123456784" oninput="detectCarrier(this.value)" autocomplete="off" spellcheck="false">
              <div id="carrierDetect">&#9889; Detected: <strong id="detectedCarrierName"></strong></div>
            </div>
            <button class="scan-btn" onclick="openScanner()">&#128247; Scan</button>
          </div>
        </div>
      </div>
      <div style="margin-bottom:12px"><label style="display:block;margin-bottom:7px">Carrier</label><div class="carrier-grid" id="carrierGrid">
        <button class="carrier-btn" data-carrier="UPS"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/United_Parcel_Service_logo_2014.svg/200px-United_Parcel_Service_logo_2014.svg.png" alt="UPS" onerror="this.style.display='none'"><span>UPS</span></button>
        <button class="carrier-btn" data-carrier="FedEx"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b9/FedEx_Corporation_-_2016_Logo.svg/200px-FedEx_Corporation_-_2016_Logo.svg.png" alt="FedEx" onerror="this.style.display='none'"><span>FedEx</span></button>
        <button class="carrier-btn" data-carrier="USPS"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/USPS_2026.svg/200px-USPS_2026.svg.png" alt="USPS" onerror="this.style.display='none'"><span>USPS</span></button>
        <button class="carrier-btn" data-carrier="DHL"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/DHL_Logo.svg/200px-DHL_Logo.svg.png" alt="DHL" onerror="this.style.display='none'"><span>DHL</span></button>
        <button class="carrier-btn" data-carrier="Amazon"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Amazon_logo.svg/200px-Amazon_logo.svg.png" alt="Amazon" onerror="this.style.display='none'"><span>Amazon</span></button>
        <button class="carrier-btn" data-carrier="OnTrac"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/OnTrac_logo.svg/200px-OnTrac_logo.svg.png" alt="OnTrac" onerror="this.style.display='none'"><span>OnTrac</span></button>
        <button class="carrier-btn" data-carrier="Estes"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Estes_Express_Lines_logo.svg/200px-Estes_Express_Lines_logo.svg.png" alt="Estes" onerror="this.style.display='none'"><span>Estes</span></button>
        <button class="carrier-btn" data-carrier="XPO"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/XPO_logo.svg/200px-XPO_logo.svg.png" alt="XPO" onerror="this.style.display='none'"><span>XPO</span></button>
        <button class="carrier-btn" data-carrier="Saia"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Saia_Inc._logo.svg/200px-Saia_Inc._logo.svg.png" alt="Saia" onerror="this.style.display='none'"><span>Saia</span></button>
        <button class="carrier-btn" data-carrier="TForce"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/TForce_Freight_logo.svg/200px-TForce_Freight_logo.svg.png" alt="TForce" onerror="this.style.display='none'"><span>TForce</span></button>
        <button class="carrier-btn" data-carrier="LaserShip"><span>LaserShip</span></button>
        <button class="carrier-btn" data-carrier="Other"><span>Other</span></button>
      </div></div>
      <div class="form-grid four" style="margin-bottom:12px">
        <div class="field"><label>Sender</label><input type="text" id="sender" placeholder="Amazon, eBay&hellip;"></div>
        <div class="field"><label>Destination</label><select id="destination"></select></div>
        <div class="field"><label>Expected Delivery</label><div class="date-wrap"><input type="date" id="expectedDate"><button type="button" class="date-btn" tabindex="-1">&#128197;</button></div></div>
        <div class="field"><label>Status</label><select id="initStatus"></select></div>
      </div>
      <div style="margin-bottom:12px"><label style="display:block;margin-bottom:7px">Tags</label><div class="tag-row" id="formTagRow"></div><div class="tag-input-wrap"><input type="text" id="newTagInput" placeholder="New tag&hellip;" onkeydown="if(event.key==='Enter')addNewTag()"><button class="tag-add-btn" onclick="addNewTag()">+ Add</button></div></div>
      <div class="form-grid" style="margin-bottom:12px">
        <div class="field"><label>PO Numbers (Enter to add each)</label><div class="po-chips-row" id="formPOChips"></div><input type="text" id="pkgPO" placeholder="PO-2024-0042&hellip;" autocomplete="off" spellcheck="false" onkeydown="addPOChip(event,'form')"></div>
        <div class="field"><label>Notes</label><input type="text" id="pkgNotes" placeholder="Leave at door, fragile&hellip;"></div>
      </div>
      <div style="margin-bottom:14px"><label style="display:block;margin-bottom:7px">Attach Photos / Files</label>
        <input type="file" id="formFileInput" accept="image/*,application/pdf" multiple style="display:none" onchange="handleFiles(event,'form')">
        <button type="button" class="attach-btn" onclick="document.getElementById('formFileInput').click()">&#128206; Attach</button>
        <div class="photo-preview" id="formPhotoPreview"></div>
      </div>
      <button class="btn" onclick="addPackage()">ADD PACKAGE</button>
    </div>
  </div>
  <div class="list-header">
    <div class="list-title">Packages</div>
    <div class="list-controls">
      <div class="view-toggle">
        <button class="view-btn active" id="vbComfort" onclick="setView('comfortable',this)" title="Comfortable">&#9636;</button>
        <button class="view-btn" id="vbCompact" onclick="setView('compact',this)" title="Compact">&#8801;</button>
      </div>
      <select class="sort-select" id="sortSelect" onchange="renderList()">
        <option value="added-desc">Newest first</option>
        <option value="added-asc">Oldest first</option>
        <option value="eta-asc">ETA soonest</option>
        <option value="eta-desc">ETA latest</option>
        <option value="po-asc">PO # A&rarr;Z</option>
        <option value="po-desc">PO # Z&rarr;A</option>
        <option value="carrier">By carrier</option>
        <option value="status">By status</option>
      </select>
      <div class="count-badge" id="countBadge">0 TRACKED</div>
    </div>
  </div>
  <div class="search-row">
    <div class="search-wrap">
      <span class="search-icon">&#8981;</span>
      <input type="text" id="searchInput" class="search-input" placeholder="Search name, tracking, PO, sender&hellip;" oninput="setSearch(this.value)">
      <button class="search-clear" id="searchClearBtn" onclick="clearSearch()" style="display:none">&#10005;</button>
    </div>
    <select id="carrierFilter" onchange="setCarrierFilter(this.value)" class="filter-select">
      <option value="">All Carriers</option>
      <option>UPS</option><option>FedEx</option><option>USPS</option><option>DHL</option>
      <option>Amazon</option><option>OnTrac</option><option>LaserShip</option>
      <option>Estes</option><option>XPO</option><option>Saia</option><option>TForce</option><option>Other</option>
    </select>
    <select id="destFilter" onchange="setDestFilter(this.value)" class="filter-select"></select>
    <button class="filter-reset-btn" onclick="resetAllFilters()" id="resetFiltersBtn" style="display:none">&#10005; Clear</button>
  </div>
  <div class="filter-bar" id="filterBar">
    <button class="filter-tab active" onclick="setStatusFilter('all',this)">All</button>
    <button class="filter-tab" onclick="setStatusFilter('pending',this)" id="ftPending">Pending</button>
    <button class="filter-tab" onclick="setStatusFilter('transit',this)" id="ftTransit">Transit</button>
    <button class="filter-tab" onclick="setStatusFilter('outdelivery',this)" id="ftOut">Out for Delivery</button>
    <button class="filter-tab" onclick="setStatusFilter('delivered',this)" id="ftDelivered">Delivered</button>
    <button class="filter-tab" onclick="setStatusFilter('exception',this)" id="ftException">Exception</button>
  </div>
  <div class="bulk-bar" id="bulkBar">
    <span class="bulk-count" id="bulkCount">0 selected</span>
    <button class="bulk-btn" onclick="bulkStatus('transit')">&#8594; Transit</button>
    <button class="bulk-btn" onclick="bulkStatus('delivered')">&#10003; Delivered</button>
    <button class="bulk-btn" onclick="bulkArchive()">&#128193; Archive</button>
    <button class="bulk-btn danger" onclick="bulkDelete()">&#128465; Delete</button>
    <button class="bulk-btn" onclick="clearSelection()">&#10005; Deselect</button>
  </div>
  <div id="packageList" class="pkg-list"></div>
</div>
<div id="calView">
  <div class="cal-nav">
    <button class="cal-nav-btn" onclick="calShift(-1)">&larr; Prev</button>
    <div class="cal-title" id="calTitle"></div>
    <button class="cal-nav-btn" onclick="calShift(1)">Next &rarr;</button>
  </div>
  <div class="cal-grid" id="calGrid"></div>
  <p class="cal-hint">Drag to reschedule &middot; Green = arriving today</p>
</div>
<div id="historyView">
  <div class="list-header">
    <div class="list-title">Archived</div>
    <div class="count-badge" id="archiveBadge">0 ARCHIVED</div>
  </div>
  <div id="historyList"></div>
</div>
<div id="editOverlay" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <div class="modal-header"><div class="modal-title">&#9998; Edit Package</div><button class="modal-close" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <input type="hidden" id="editId"><input type="hidden" id="editIsArchived">
      <div class="form-grid" style="margin-bottom:12px">
        <div class="field"><label>Name</label><input type="text" id="editName"></div>
        <div class="field"><label>Tracking</label><input type="text" id="editTracking" autocomplete="off" spellcheck="false"></div>
      </div>
      <div style="margin-bottom:12px"><label style="display:block;margin-bottom:7px">Carrier</label><div class="carrier-grid" id="editCarrierGrid">
        <button class="carrier-btn" data-carrier="UPS"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/United_Parcel_Service_logo_2014.svg/200px-United_Parcel_Service_logo_2014.svg.png" alt="UPS" onerror="this.style.display='none'"><span>UPS</span></button>
        <button class="carrier-btn" data-carrier="FedEx"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b9/FedEx_Corporation_-_2016_Logo.svg/200px-FedEx_Corporation_-_2016_Logo.svg.png" alt="FedEx" onerror="this.style.display='none'"><span>FedEx</span></button>
        <button class="carrier-btn" data-carrier="USPS"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/USPS_2026.svg/200px-USPS_2026.svg.png" alt="USPS" onerror="this.style.display='none'"><span>USPS</span></button>
        <button class="carrier-btn" data-carrier="DHL"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/DHL_Logo.svg/200px-DHL_Logo.svg.png" alt="DHL" onerror="this.style.display='none'"><span>DHL</span></button>
        <button class="carrier-btn" data-carrier="Amazon"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Amazon_logo.svg/200px-Amazon_logo.svg.png" alt="Amazon" onerror="this.style.display='none'"><span>Amazon</span></button>
        <button class="carrier-btn" data-carrier="OnTrac"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/OnTrac_logo.svg/200px-OnTrac_logo.svg.png" alt="OnTrac" onerror="this.style.display='none'"><span>OnTrac</span></button>
        <button class="carrier-btn" data-carrier="Estes"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Estes_Express_Lines_logo.svg/200px-Estes_Express_Lines_logo.svg.png" alt="Estes" onerror="this.style.display='none'"><span>Estes</span></button>
        <button class="carrier-btn" data-carrier="XPO"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/XPO_logo.svg/200px-XPO_logo.svg.png" alt="XPO" onerror="this.style.display='none'"><span>XPO</span></button>
        <button class="carrier-btn" data-carrier="Saia"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Saia_Inc._logo.svg/200px-Saia_Inc._logo.svg.png" alt="Saia" onerror="this.style.display='none'"><span>Saia</span></button>
        <button class="carrier-btn" data-carrier="TForce"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/TForce_Freight_logo.svg/200px-TForce_Freight_logo.svg.png" alt="TForce" onerror="this.style.display='none'"><span>TForce</span></button>
        <button class="carrier-btn" data-carrier="LaserShip"><span>LaserShip</span></button>
        <button class="carrier-btn" data-carrier="Other"><span>Other</span></button>
      </div></div>
      <div class="form-grid four" style="margin-bottom:12px">
        <div class="field"><label>Sender</label><input type="text" id="editSender"></div>
        <div class="field"><label>Destination</label><select id="editDestination"></select></div>
        <div class="field"><label>Expected</label><div class="date-wrap"><input type="date" id="editExpected"><button type="button" class="date-btn" tabindex="-1">&#128197;</button></div></div>
        <div class="field"><label>Status</label><select id="editStatus"></select></div>
      </div>
      <div style="margin-bottom:12px"><label style="display:block;margin-bottom:7px">Tags</label><div class="tag-row" id="editTagRow"></div></div>
      <div class="form-grid" style="margin-bottom:12px">
        <div class="field"><label>PO Numbers</label><div class="po-chips-row" id="editPOChips"></div><input type="text" id="editPO" placeholder="Add PO then Enter&hellip;" autocomplete="off" spellcheck="false" onkeydown="addPOChip(event,'edit')"></div>
        <div class="field"><label>Add Timestamped Note</label>
          <div class="note-add-row"><input type="text" id="editNoteInput" placeholder="Note text&hellip;" onkeydown="if(event.key==='Enter')saveNote()"><button class="btn-sm" onclick="saveNote()">Add</button></div>
          <div class="note-history-list" id="editNoteHistory"></div>
        </div>
      </div>
      <div style="margin-bottom:14px"><label style="display:block;margin-bottom:7px">Attachments</label>
        <input type="file" id="editFileInput" accept="image/*,application/pdf" multiple style="display:none" onchange="handleFiles(event,'edit')">
        <button type="button" class="attach-btn" onclick="document.getElementById('editFileInput').click()">&#128206; Attach</button>
        <div class="photo-preview" id="editPhotoPreview"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="saveEdit()" style="width:auto;padding:11px 32px">SAVE CHANGES</button>
        <button class="modal-cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>
<div id="settingsOverlay" class="modal-overlay" onclick="if(event.target===this)closeSettings()">
  <div class="modal-box" style="max-width:640px">
    <div class="modal-header"><div class="modal-title">&#9881; Settings</div><button class="modal-close" onclick="closeSettings()">&#10005;</button></div>
    <div class="modal-body">
      <div class="modal-section">&#128276; Push Notifications</div>
      <div class="notif-row"><div class="notif-dot off" id="notifDot"></div><div class="notif-label" id="notifLabel">Get overdue alerts in browser</div><button class="notif-enable-btn" id="notifBtn" onclick="requestNotif()">Enable</button></div>
      <div class="settings-row">
        <div><div class="settings-label">Overdue threshold</div><div class="settings-sub">Flag as overdue N days after ETA (0 = same day)</div></div>
        <div style="display:flex;align-items:center;gap:6px"><input type="number" id="overdueThreshInput" min="0" max="30" style="width:56px;text-align:center;padding:5px 7px;font-size:13px" oninput="saveOverdueThresh()"><span style="font-size:11px;color:var(--muted)">days</span></div>
      </div>
      <div class="modal-section">&#9889; Quick-Add Defaults</div>
      <div class="form-grid">
        <div class="field"><label>Default Carrier</label><select id="qaCarrierSel" onchange="localStorage.setItem('trackQACarrier',this.value)"></select></div>
        <div class="field"><label>Default Destination</label><select id="qaDestSel" onchange="localStorage.setItem('trackQADest',this.value)"></select></div>
      </div>
      <div class="modal-section">&#128205; Custom Destinations</div>
      <div id="destList"></div>
      <div class="dest-add-row"><input type="text" id="newDestInput" placeholder="e.g. Warehouse A, Job Site 3&hellip;" onkeydown="if(event.key==='Enter')addDest()"><button class="dest-add-btn" onclick="addDest()">+ Add</button></div>
      <div class="modal-section">&#127991; Custom Status Labels</div>
      <div class="status-label-grid" id="statusLabelGrid"></div>
      <button style="margin-top:10px;padding:7px 14px;background:var(--accent);color:var(--bg);border:none;font-family:var(--font);font-weight:700;font-size:10px;letter-spacing:1px;cursor:pointer" onclick="saveStatusLabels()">SAVE LABELS</button>
    </div>
  </div>
</div>
<div id="templatesOverlay" class="modal-overlay" onclick="if(event.target===this)closeTemplates()">
  <div class="modal-box" style="max-width:500px">
    <div class="modal-header"><div class="modal-title">&#128203; Templates</div><button class="modal-close" onclick="closeTemplates()">&#10005;</button></div>
    <div class="modal-body">
      <p style="font-size:11px;color:var(--muted);margin-bottom:14px">Save current form state as a reusable preset (carrier, destination, tags, status).</p>
      <div id="templateList" style="margin-bottom:14px"></div>
      <div style="display:flex;gap:8px"><input type="text" id="tplNameInput" placeholder="Template name&hellip;" style="flex:1;font-size:12px" onkeydown="if(event.key==='Enter')saveTemplate()"><button class="btn" style="width:auto;padding:10px 18px;font-size:11px" onclick="saveTemplate()">SAVE CURRENT FORM</button></div>
    </div>
  </div>
</div>
<div id="kbOverlay" class="modal-overlay" onclick="if(event.target===this)closeKb()">
  <div class="modal-box" style="max-width:420px">
    <div class="modal-header"><div class="modal-title">&#9000; Shortcuts</div><button class="modal-close" onclick="closeKb()">&#10005;</button></div>
    <div class="modal-body">
      <div class="kb-grid">
        <span class="kb-key">N</span><span class="kb-desc">Open add form</span>
        <span class="kb-key">/</span><span class="kb-desc">Focus search</span>
        <span class="kb-key">Esc</span><span class="kb-desc">Close modal / clear search</span>
        <span class="kb-key">1 2 3</span><span class="kb-desc">Switch tabs</span>
        <span class="kb-key">T</span><span class="kb-desc">Toggle theme</span>
        <span class="kb-key">C</span><span class="kb-desc">Toggle compact view</span>
        <span class="kb-key">?</span><span class="kb-desc">Show shortcuts</span>
      </div>
    </div>
  </div>
</div>
<div id="scanOverlay">
  <div class="scan-hint">Point camera at a barcode or QR code</div>
  <video id="scanVideo" autoplay playsinline muted></video>
  <div class="scan-hint" id="scanStatus">Initializing&hellip;</div>
  <button class="scan-close" onclick="closeScanner()">&#10005; Cancel</button>
</div>
<div id="lightbox" onclick="document.getElementById('lightbox').classList.remove('open')">
  <button class="lb-close" onclick="document.getElementById('lightbox').classList.remove('open')">&#10005;</button>
  <img id="lbImg" src="" alt="">
</div>
<footer>TRACK &mdash; All data stored locally in your browser &mdash; No server required</footer>
</div>

<script>
let packages=JSON.parse(localStorage.getItem('trackPackages')||'[]');
let archived=JSON.parse(localStorage.getItem('trackArchived')||'[]');
let allTags=JSON.parse(localStorage.getItem('trackTags')||'["Office","Drop Ship","Urgent","Sample"]');
let customDests=JSON.parse(localStorage.getItem('trackDests')||'["Drop Ship","Office","Warehouse","Job Site","Other"]');
let customStatusLabels=JSON.parse(localStorage.getItem('trackStatusLabels')||'{}');
let templates=JSON.parse(localStorage.getItem('trackTemplates')||'[]');
let overdueThresh=parseInt(localStorage.getItem('trackOverdueThresh')||'0',10);
let colorRows=localStorage.getItem('trackColorRows')==='1';
let viewMode=localStorage.getItem('trackViewMode')||'comfortable';
let selectedCarrier='',selectedFormTags=[],formPOs=[],formAttachments=[];
let editCarrier='',editTagsSel=[],editPOs=[],editAttachments=[];
let qaDetectedCarrier='';
let currentStatusFilter='all',currentTagFilter='',searchQuery='';
let currentCarrierFilter='',currentDestFilter='';
let selectedIds=new Set();
const nowD=new Date();
let calYear=nowD.getFullYear(),calMonth=nowD.getMonth();
const carrierKey={UPS:'ups',FedEx:'fedex',USPS:'usps',DHL:'dhl',Amazon:'amazon',OnTrac:'ontrac',LaserShip:'lasership',Estes:'estes',XPO:'xpo',Saia:'saia',TForce:'tforce',Other:'other'};
const carrierLogos={
  UPS:'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/United_Parcel_Service_logo_2014.svg/200px-United_Parcel_Service_logo_2014.svg.png',
  FedEx:'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b9/FedEx_Corporation_-_2016_Logo.svg/200px-FedEx_Corporation_-_2016_Logo.svg.png',
  USPS:'https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/USPS_2026.svg/200px-USPS_2026.svg.png',
  DHL:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/DHL_Logo.svg/200px-DHL_Logo.svg.png',
  Amazon:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Amazon_logo.svg/200px-Amazon_logo.svg.png',
  OnTrac:'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/OnTrac_logo.svg/200px-OnTrac_logo.svg.png',
  Estes:'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Estes_Express_Lines_logo.svg/200px-Estes_Express_Lines_logo.svg.png',
  XPO:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/XPO_logo.svg/200px-XPO_logo.svg.png',
  Saia:'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Saia_Inc._logo.svg/200px-Saia_Inc._logo.svg.png',
  TForce:'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/TForce_Freight_logo.svg/200px-TForce_Freight_logo.svg.png'
};
const trackingUrls={
  UPS:'https://www.ups.com/track?tracknum=',FedEx:'https://www.fedex.com/fedextrack/?trknbr=',
  USPS:'https://tools.usps.com/go/TrackConfirmAction?tLabels=',DHL:'https://www.dhl.com/us-en/home/tracking.html?tracking-id=',
  Amazon:'https://www.amazon.com/gp/your-account/ship-track?orderID=',OnTrac:'https://www.ontrac.com/tracking/?number=',
  LaserShip:'https://www.lasership.com/track/',Estes:'https://www.estes-express.com/myestes/shipment-tracking/?pro=',
  XPO:'https://www.xpo.com/tools-and-resources/tracking/?num=',Saia:'https://www.saia.com/track/details;pro=',
  TForce:'https://www.tforcefreight.com/ltl/apps/pickup-and-delivery-tracking?pro='
};
const defSL={pending:'Pending',transit:'In Transit',outdelivery:'Out for Delivery',delivered:'Delivered',exception:'Exception',return:'Returning'};
const carrierPatterns=[
  {carrier:'UPS',regex:/^1Z[0-9A-Z]{16}$|^(T\d{10}|K\d{10}|J\d{10}|H\d{10})$/i},
  {carrier:'FedEx',regex:/^(\d{12}|\d{15}|\d{20}|DT\d{12}|96\d{20}|7489\d{16}|6129\d{16})$/},
  {carrier:'USPS',regex:/^(9[0-9]{19,21}|9[0-9]{15}|82[0-9]{8}|[A-Z]{2}[0-9]{9}US)$/i},
  {carrier:'DHL',regex:/^(\d{10}|JD\d{18}|GM\d{16}|00340\d{15}|JVGL\d{12})$/},
  {carrier:'Amazon',regex:/^TBA\d{12,16}$|^D\d{13}$/i},
  {carrier:'OnTrac',regex:/^C\d{14}$/},
  {carrier:'LaserShip',regex:/^(1LS|L)[0-9]{8,14}$/i},
  {carrier:'Estes',regex:/^(0?[0-9]{9}|1[0-9]{9})$/},
  {carrier:'Saia',regex:/^[0-9]{3}-[0-9]{6}$|^[0-9]{9}$/},
  {carrier:'XPO',regex:/^[0-9]{10}$/},
  {carrier:'TForce',regex:/^[0-9]{3}-[0-9]{6}$/}
];
function sl(k){return customStatusLabels[k]||defSL[k]||k;}
function save(){
  localStorage.setItem('trackPackages',JSON.stringify(packages));
  localStorage.setItem('trackArchived',JSON.stringify(archived));
  localStorage.setItem('trackTags',JSON.stringify(allTags));
  localStorage.setItem('trackDests',JSON.stringify(customDests));
  localStorage.setItem('trackStatusLabels',JSON.stringify(customStatusLabels));
  localStorage.setItem('trackTemplates',JSON.stringify(templates));
}
function toggleTheme(){const l=document.body.classList.toggle('light');localStorage.setItem('trackTheme',l?'light':'dark');document.getElementById('themeBtn').textContent=l?'\u{1F319} Theme':'\u2600 Theme';}
if(localStorage.getItem('trackTheme')==='light'){document.body.classList.add('light');document.getElementById('themeBtn').textContent='\u{1F319} Theme';}
function toggleColorRows(){colorRows=!colorRows;localStorage.setItem('trackColorRows',colorRows?'1':'0');document.getElementById('colorBtn').classList.toggle('on',colorRows);renderList();}
if(colorRows)document.getElementById('colorBtn').classList.add('on');
function setView(mode){viewMode=mode;localStorage.setItem('trackViewMode',mode);document.getElementById('packageList').className='pkg-list'+(mode==='compact'?' compact':'');document.getElementById('vbComfort').classList.toggle('active',mode==='comfortable');document.getElementById('vbCompact').classList.toggle('active',mode==='compact');}
setView(viewMode);
function openKb(){document.getElementById('kbOverlay').classList.add('open');document.body.style.overflow='hidden';}
function closeKb(){document.getElementById('kbOverlay').classList.remove('open');document.body.style.overflow='';}
document.addEventListener('keydown',e=>{
  const t=document.activeElement.tagName,typing=t==='INPUT'||t==='TEXTAREA'||t==='SELECT';
  if(e.key==='Escape'){closeModal();closeKb();closeSettings();closeTemplates();clearSearch();return;}
  if(typing)return;
  if(e.key==='?'){openKb();return;}
  if(e.key==='n'||e.key==='N'){openAddForm();return;}
  if(e.key==='/'){e.preventDefault();document.getElementById('searchInput').focus();return;}
  if(e.key==='1')switchView('packages',document.querySelectorAll('.main-tab')[0]);
  if(e.key==='2')switchView('calendar',document.querySelectorAll('.main-tab')[1]);
  if(e.key==='3')switchView('history',document.querySelectorAll('.main-tab')[2]);
  if(e.key==='t'||e.key==='T')toggleTheme();
  if(e.key==='c'||e.key==='C')setView(viewMode==='compact'?'comfortable':'compact');
});
function toggleAddForm(){const f=document.getElementById('addForm'),a=document.getElementById('addFormArrow');const open=f.classList.toggle('open');a.classList.toggle('open',open);a.textContent=open?'\u25BC':'\u25BA';if(open)setTimeout(()=>document.getElementById('pkgName').focus(),80);}
function openAddForm(){if(!document.getElementById('addForm').classList.contains('open'))toggleAddForm();}
function bDS(id,cur=''){const s=document.getElementById(id);if(!s)return;s.innerHTML='<option value="">— Select —</option>'+customDests.map(d=>`<option value="${d}"${d===cur?' selected':''}>${d}</option>`).join('');}
function bSS(id,cur='pending'){const s=document.getElementById(id);if(!s)return;s.innerHTML=Object.keys(defSL).map(k=>`<option value="${k}"${k===cur?' selected':''}>${sl(k)}</option>`).join('');}
function bDF(){const s=document.getElementById('destFilter');s.innerHTML='<option value="">All Destinations</option>'+customDests.map(d=>`<option value="${d}">${d}</option>`).join('');s.value=currentDestFilter;}
function rebuildAll(){
  bDS('destination');bDS('editDestination');bSS('initStatus');bSS('editStatus');bDF();
  const qc=document.getElementById('qaCarrierSel');
  if(qc){const v=localStorage.getItem('trackQACarrier')||'';qc.innerHTML='<option value="">None</option>'+Object.keys(carrierKey).map(c=>`<option value="${c}"${c===v?' selected':''}>${c}</option>`).join('');}
  const qd=document.getElementById('qaDestSel');
  if(qd){const v=localStorage.getItem('trackQADest')||'';qd.innerHTML='<option value="">None</option>'+customDests.map(d=>`<option value="${d}"${d===v?' selected':''}>${d}</option>`).join('');}
  document.getElementById('ftPending').textContent=sl('pending');
  document.getElementById('ftTransit').textContent=sl('transit');
  document.getElementById('ftOut').textContent=sl('outdelivery');
  document.getElementById('ftDelivered').textContent=sl('delivered');
  document.getElementById('ftException').textContent=sl('exception');
  const g=document.getElementById('statusLabelGrid');
  if(g)g.innerHTML=Object.keys(defSL).map(k=>`<div class="status-label-row"><label>${defSL[k]}</label><input type="text" id="slbl_${k}" value="${customStatusLabels[k]||''}" placeholder="${defSL[k]}"></div>`).join('');
}
function addNewTag(){const inp=document.getElementById('newTagInput'),n=inp.value.trim();if(!n)return;if(!allTags.includes(n)){allTags.push(n);save();}if(!selectedFormTags.includes(n))selectedFormTags.push(n);inp.value='';renderFormTags();renderTagFilters();}
function toggleFormTag(t){selectedFormTags=selectedFormTags.includes(t)?selectedFormTags.filter(x=>x!==t):[...selectedFormTags,t];renderFormTags();}
function renderFormTags(){document.getElementById('formTagRow').innerHTML=allTags.map(t=>`<div class="tag-chip${selectedFormTags.includes(t)?' selected':''}" onclick="toggleFormTag('${t}')">${t}</div>`).join('');}
function toggleEditTag(t){editTagsSel=editTagsSel.includes(t)?editTagsSel.filter(x=>x!==t):[...editTagsSel,t];renderEditTags();}
function renderEditTags(){document.getElementById('editTagRow').innerHTML=allTags.map(t=>`<div class="tag-chip${editTagsSel.includes(t)?' selected':''}" onclick="toggleEditTag('${t}')">${t}</div>`).join('');}
function renderTagFilters(){
  const bar=document.getElementById('filterBar');
  bar.querySelectorAll('.tag-filter,.tag-sep').forEach(el=>el.remove());
  if(!allTags.length)return;
  bar.appendChild(Object.assign(document.createElement('div'),{className:'filter-sep tag-sep'}));
  allTags.forEach(tag=>{const btn=Object.assign(document.createElement('button'),{className:'filter-tab tag-filter'+(currentTagFilter===tag?' active':''),textContent:'# '+tag,onclick(){setTagFilter(tag,this);}});bar.appendChild(btn);});
}
function setTagFilter(tag,el){currentTagFilter=currentTagFilter===tag?'':tag;document.querySelectorAll('.filter-tab.tag-filter').forEach(b=>b.classList.remove('active'));if(currentTagFilter)el.classList.add('active');updateResetBtn();renderList();}
function addPOChip(e,ctx){if(e.key!=='Enter'&&e.key!==',')return;e.preventDefault();const inp=document.getElementById(ctx==='form'?'pkgPO':'editPO'),v=inp.value.trim();if(!v)return;if(ctx==='form'){if(!formPOs.includes(v))formPOs.push(v);rPOC('formPOChips',formPOs,'form');}else{if(!editPOs.includes(v))editPOs.push(v);rPOC('editPOChips',editPOs,'edit');}inp.value='';}
function removePO(v,ctx){if(ctx==='form'){formPOs=formPOs.filter(p=>p!==v);rPOC('formPOChips',formPOs,'form');}else{editPOs=editPOs.filter(p=>p!==v);rPOC('editPOChips',editPOs,'edit');}}
function rPOC(id,pos,ctx){document.getElementById(id).innerHTML=(pos||[]).map(p=>`<span class="po-chip">${p}<button class="po-chip-del" data-po="${p}" data-ctx="${ctx}" onclick="removePO(this.dataset.po,this.dataset.ctx)">×</button></span>`).join('');}
function getPOs(pkg){return(pkg.pos&&pkg.pos.length)?pkg.pos:(pkg.po?[pkg.po]:[]);}
function handleFiles(e,ctx){Array.from(e.target.files).forEach(file=>{const r=new FileReader();r.onload=ev=>{const a={name:file.name,type:file.type,data:ev.target.result};if(ctx==='form'){formAttachments.push(a);rPP('formPhotoPreview',formAttachments,'form');}else{editAttachments.push(a);rPP('editPhotoPreview',editAttachments,'edit');}};r.readAsDataURL(file);});e.target.value='';}
function rPP(id,atts,ctx){document.getElementById(id).innerHTML=(atts||[]).map((a,i)=>{const isImg=a.type&&a.type.startsWith('image/');return`<div class="photo-thumb-wrap">${isImg?`<img src="${a.data}" class="photo-thumb" onclick="openLightbox('${a.data}')" title="${a.name}">`:`<div style="padding:5px 9px;background:var(--surface2);border:1px solid var(--border);font-size:9px;color:var(--muted);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${a.name}</div>`}<button class="thumb-del" onclick="removeAtt(${i},'${ctx}')">×</button></div>`;}).join('');}
function removeAtt(i,ctx){if(ctx==='form'){formAttachments.splice(i,1);rPP('formPhotoPreview',formAttachments,'form');}else{editAttachments.splice(i,1);rPP('editPhotoPreview',editAttachments,'edit');}}
function openLightbox(src){document.getElementById('lbImg').src=src;document.getElementById('lightbox').classList.add('open');}
function saveNote(){const pkgId=document.getElementById('editId').value,fa=document.getElementById('editIsArchived').value==='1',list=fa?archived:packages,pkg=list.find(p=>p.id===pkgId);if(!pkg)return;const inp=document.getElementById('editNoteInput'),text=inp.value.trim();if(!text)return;if(!pkg.noteHistory)pkg.noteHistory=[];pkg.noteHistory.unshift({text,time:new Date().toISOString()});inp.value='';rNH(pkg);save();}
function rNH(pkg){const el=document.getElementById('editNoteHistory');if(!el)return;if(!pkg.noteHistory||!pkg.noteHistory.length){el.innerHTML='<div style="font-size:10px;color:var(--muted)">No notes yet</div>';return;}el.innerHTML=pkg.noteHistory.map(n=>`<div class="note-h-entry"><span class="note-h-time">${fmtDate(n.time)}</span><span class="note-h-text">${n.text}</span></div>`).join('');}
function detectCarrier(val){val=val.trim().toUpperCase();const hint=document.getElementById('carrierDetect');if(!val||val.length<6){hint.style.display='none';return;}for(const {carrier,regex} of carrierPatterns){if(regex.test(val)){document.getElementById('detectedCarrierName').textContent=carrier;hint.style.display='block';document.querySelectorAll('#carrierGrid .carrier-btn').forEach(b=>b.classList.toggle('selected',b.dataset.carrier===carrier));selectedCarrier=carrier;return;}}hint.style.display='none';}
function qaDetect(val){val=val.trim().toUpperCase();for(const {carrier,regex} of carrierPatterns)if(regex.test(val)){qaDetectedCarrier=carrier;return;}qaDetectedCarrier='';}
document.getElementById('carrierGrid').addEventListener('click',e=>{const b=e.target.closest('.carrier-btn');if(!b)return;document.querySelectorAll('#carrierGrid .carrier-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');selectedCarrier=b.dataset.carrier;document.getElementById('carrierDetect').style.display='none';});
document.getElementById('editCarrierGrid').addEventListener('click',e=>{const b=e.target.closest('.carrier-btn');if(!b)return;document.querySelectorAll('#editCarrierGrid .carrier-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');editCarrier=b.dataset.carrier;});
function setSearch(v){searchQuery=v.trim().toLowerCase();document.getElementById('searchClearBtn').style.display=v?'block':'none';updateResetBtn();renderList();}
function clearSearch(){searchQuery='';document.getElementById('searchInput').value='';document.getElementById('searchClearBtn').style.display='none';updateResetBtn();renderList();}
function setCarrierFilter(v){currentCarrierFilter=v;updateResetBtn();renderList();}
function setDestFilter(v){currentDestFilter=v;updateResetBtn();renderList();}
function setStatusFilter(f,el){currentStatusFilter=f;document.querySelectorAll('.filter-tab:not(.tag-filter)').forEach(b=>b.classList.remove('active'));el.classList.add('active');updateResetBtn();renderList();}
function filterByStat(s){resetAllFilters();currentStatusFilter=s;renderList();}
function filterOverdue(){currentStatusFilter='__overdue__';document.querySelectorAll('.filter-tab:not(.tag-filter)').forEach(b=>b.classList.remove('active'));updateResetBtn();switchView('packages',document.querySelectorAll('.main-tab')[0]);renderList();}
function filterToday(){currentStatusFilter='__today__';document.querySelectorAll('.filter-tab:not(.tag-filter)').forEach(b=>b.classList.remove('active'));updateResetBtn();switchView('packages',document.querySelectorAll('.main-tab')[0]);renderList();}
function resetAllFilters(){searchQuery='';currentCarrierFilter='';currentDestFilter='';currentStatusFilter='all';currentTagFilter='';document.getElementById('searchInput').value='';document.getElementById('searchClearBtn').style.display='none';document.getElementById('carrierFilter').value='';document.getElementById('destFilter').value='';document.querySelectorAll('.filter-tab:not(.tag-filter)').forEach((b,i)=>b.classList.toggle('active',i===0));document.querySelectorAll('.filter-tab.tag-filter').forEach(b=>b.classList.remove('active'));updateResetBtn();renderList();}
function updateResetBtn(){const a=searchQuery||currentCarrierFilter||currentDestFilter||currentStatusFilter!=='all'||currentTagFilter;document.getElementById('resetFiltersBtn').style.display=a?'flex':'none';}
function hl(text,q){if(!q||!text)return text||'';const s=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');return String(text).replace(new RegExp(`(${s})`,'gi'),'<mark>$1</mark>');}
function sortPackages(list){const s=document.getElementById('sortSelect').value,sorted=[...list],so={pending:0,transit:1,outdelivery:2,exception:3,return:4,delivered:5};if(s==='added-desc')sorted.sort((a,b)=>b.addedAt.localeCompare(a.addedAt));if(s==='added-asc')sorted.sort((a,b)=>a.addedAt.localeCompare(b.addedAt));if(s==='eta-asc')sorted.sort((a,b)=>(a.expectedDate||'9999').localeCompare(b.expectedDate||'9999'));if(s==='eta-desc')sorted.sort((a,b)=>(b.expectedDate||'').localeCompare(a.expectedDate||''));if(s==='po-asc')sorted.sort((a,b)=>(getPOs(a)[0]||'').localeCompare(getPOs(b)[0]||''));if(s==='po-desc')sorted.sort((a,b)=>(getPOs(b)[0]||'').localeCompare(getPOs(a)[0]||''));if(s==='carrier')sorted.sort((a,b)=>a.carrier.localeCompare(b.carrier));if(s==='status')sorted.sort((a,b)=>(so[a.status]||0)-(so[b.status]||0));return sorted;}
function isOverdue(pkg){if(!pkg.expectedDate||pkg.status==='delivered'||pkg.status==='return')return false;const today=new Date();today.setHours(0,0,0,0);return Math.floor((today-new Date(pkg.expectedDate+'T12:00:00'))/86400000)>overdueThresh;}
function isToday(pkg){if(!pkg.expectedDate||pkg.status==='delivered')return false;const t=new Date();return pkg.expectedDate===`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;}
function updateStats(){let tr=0,out=0,del=0,ov=0,tod=0;packages.forEach(p=>{if(p.status==='transit')tr++;if(p.status==='outdelivery')out++;if(p.status==='delivered')del++;if(isOverdue(p))ov++;if(isToday(p))tod++;});document.getElementById('statTotal').textContent=packages.length;document.getElementById('statTransit').textContent=tr;document.getElementById('statOut').textContent=out;document.getElementById('statDelivered').textContent=del;document.getElementById('statOverdue').textContent=ov;const ob=document.getElementById('overdueBanner');ob.classList.toggle('show',ov>0);if(ov>0)document.getElementById('overdueText').textContent=`${ov} package${ov>1?'s are':' is'} past ETA${overdueThresh>0?` (+${overdueThresh}d)`:''}`; const tb=document.getElementById('todayBanner');tb.classList.toggle('show',tod>0);if(tod>0)document.getElementById('todayText').textContent=`${tod} package${tod>1?'s':''} arriving today`;if(Notification.permission==='granted'&&ov>0){const key='notif_od_'+new Date().toDateString();if(!sessionStorage.getItem(key)){new Notification('TRACK — Overdue',{body:`${ov} package${ov>1?'s':''} overdue`});sessionStorage.setItem(key,'1');}}}
function quickAdd(){const name=document.getElementById('qaName').value.trim();if(!name){alert('Enter a package name.');return;}const tracking=document.getElementById('qaTracking').value.trim(),carrier=qaDetectedCarrier||localStorage.getItem('trackQACarrier')||'Other',dest=localStorage.getItem('trackQADest')||'';packages.unshift({id:Date.now().toString(),name,tracking,carrier,sender:'',destination:dest,expectedDate:'',status:'pending',notes:'',noteHistory:[],pos:[],tags:[],addedAt:new Date().toISOString(),attachments:[],events:[{id:Date.now().toString(),status:'pending',location:'Origin',note:'Quick added',time:new Date().toISOString()}]});save();renderList();renderCalendar();updateStats();document.getElementById('qaName').value='';document.getElementById('qaTracking').value='';qaDetectedCarrier='';}
function addPackage(){const name=document.getElementById('pkgName').value.trim();if(!name){alert('Please enter a package name.');return;}const poInp=document.getElementById('pkgPO').value.trim();if(poInp&&!formPOs.includes(poInp))formPOs.push(poInp);const notes=document.getElementById('pkgNotes').value.trim();packages.unshift({id:Date.now().toString(),name,tracking:document.getElementById('trackNum').value.trim(),carrier:selectedCarrier||'Other',sender:document.getElementById('sender').value.trim(),destination:document.getElementById('destination').value,expectedDate:document.getElementById('expectedDate').value,status:document.getElementById('initStatus').value,notes,noteHistory:notes?[{text:notes,time:new Date().toISOString()}]:[],pos:[...formPOs],tags:[...selectedFormTags],addedAt:new Date().toISOString(),attachments:JSON.parse(JSON.stringify(formAttachments)),events:[{id:Date.now().toString(),status:document.getElementById('initStatus').value,location:document.getElementById('sender').value.trim()||'Origin',note:notes||'',time:new Date().toISOString()}]});save();renderList();renderCalendar();updateStats();['pkgName','trackNum','sender','pkgNotes','pkgPO'].forEach(id=>document.getElementById(id).value='');bDS('destination');bSS('initStatus');document.querySelectorAll('#carrierGrid .carrier-btn').forEach(b=>b.classList.remove('selected'));document.getElementById('carrierDetect').style.display='none';document.getElementById('formPOChips').innerHTML='';document.getElementById('formPhotoPreview').innerHTML='';selectedCarrier='';selectedFormTags=[];formPOs=[];formAttachments=[];renderFormTags();}
function updateStatus(pkgId,ns){const pkg=packages.find(p=>p.id===pkgId);if(!pkg)return;pkg.status=ns;if(ns==='delivered'&&!pkg.deliveredAt)pkg.deliveredAt=new Date().toISOString();pkg.events.unshift({id:Date.now().toString(),status:ns,location:pkg.destination||'—',note:'Manual update',time:new Date().toISOString()});save();renderList();renderCalendar();updateStats();}
function deletePackage(id){if(!confirm('Permanently delete?'))return;packages=packages.filter(p=>p.id!==id);selectedIds.delete(id);save();renderList();renderCalendar();updateStats();}
function archivePackage(id){const pkg=packages.find(p=>p.id===id);if(!pkg)return;pkg.archivedAt=new Date().toISOString();archived.unshift(pkg);packages=packages.filter(p=>p.id!==id);selectedIds.delete(id);save();renderList();renderCalendar();renderHistory();updateHistoryBadge();updateStats();}
function duplicatePackage(id){const src=packages.find(p=>p.id===id);if(!src)return;const copy={...JSON.parse(JSON.stringify(src)),id:Date.now().toString(),name:src.name+' (copy)',addedAt:new Date().toISOString(),status:'pending',deliveredAt:null,events:[{id:Date.now().toString(),status:'pending',location:'Origin',note:'Duplicated',time:new Date().toISOString()}]};packages.splice(packages.findIndex(p=>p.id===id)+1,0,copy);save();renderList();renderCalendar();updateStats();}
function restorePackage(id){const pkg=archived.find(p=>p.id===id);if(!pkg)return;delete pkg.archivedAt;packages.unshift(pkg);archived=archived.filter(p=>p.id!==id);save();renderList();renderCalendar();renderHistory();updateHistoryBadge();updateStats();}
function deleteArchived(id){if(!confirm('Permanently delete?'))return;archived=archived.filter(p=>p.id!==id);save();renderHistory();updateHistoryBadge();}
function updateHistoryBadge(){const tab=document.getElementById('historyTab'),ex=tab.querySelector('.tab-badge');if(archived.length){if(ex)ex.textContent=archived.length;else{const b=document.createElement('span');b.className='tab-badge';b.textContent=archived.length;tab.appendChild(b);}}else if(ex)ex.remove();document.getElementById('archiveBadge').textContent=archived.length+' ARCHIVED';}
function addEvent(pkgId){const pkg=packages.find(p=>p.id===pkgId);if(!pkg)return;const s=document.getElementById('ev-s-'+pkgId).value,loc=document.getElementById('ev-l-'+pkgId).value.trim(),note=document.getElementById('ev-n-'+pkgId).value.trim();if(s==='delivered'&&!pkg.deliveredAt)pkg.deliveredAt=new Date().toISOString();pkg.events.unshift({id:Date.now().toString(),status:s,location:loc||'Unknown',note,time:new Date().toISOString()});pkg.status=s;document.getElementById('ev-l-'+pkgId).value='';document.getElementById('ev-n-'+pkgId).value='';save();renderList();renderCalendar();updateStats();setTimeout(()=>{const tl=document.getElementById('tl-'+pkgId);if(tl)tl.classList.add('open');},40);}
function toggleTimeline(id){document.getElementById('tl-'+id).classList.toggle('open');}
function toggleSelect(id,checked){checked?selectedIds.add(id):selectedIds.delete(id);updateBulkBar();}
function clearSelection(){selectedIds.clear();document.querySelectorAll('.pkg-checkbox').forEach(cb=>cb.checked=false);updateBulkBar();}
function updateBulkBar(){const n=selectedIds.size;document.getElementById('bulkBar').classList.toggle('show',n>0);document.getElementById('bulkCount').textContent=`${n} package${n!==1?'s':''} selected`;}
function bulkStatus(s){selectedIds.forEach(id=>{const p=packages.find(q=>q.id===id);if(!p)return;p.status=s;if(s==='delivered'&&!p.deliveredAt)p.deliveredAt=new Date().toISOString();p.events.unshift({id:Date.now().toString(),status:s,location:'—',note:'Bulk update',time:new Date().toISOString()});});selectedIds.clear();save();renderList();renderCalendar();updateStats();}
function bulkArchive(){packages.filter(p=>selectedIds.has(p.id)).forEach(p=>{p.archivedAt=new Date().toISOString();archived.unshift(p);});packages=packages.filter(p=>!selectedIds.has(p.id));selectedIds.clear();save();renderList();renderCalendar();renderHistory();updateHistoryBadge();updateStats();}
function bulkDelete(){if(!confirm(`Delete ${selectedIds.size} packages?`))return;packages=packages.filter(p=>!selectedIds.has(p.id));selectedIds.clear();save();renderList();renderCalendar();updateStats();}
function fmtDate(iso){if(!iso)return'';const d=new Date(iso);return d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});}
function fmtEta(ds){if(!ds)return'';const d=new Date(ds+'T12:00:00'),diff=Math.ceil((d-new Date())/86400000),lbl=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});if(diff<0)return lbl+' <span class="overdue-flag">OVERDUE</span>';if(diff===0)return lbl+' <span style="color:var(--green);font-size:9px;font-weight:700">\u2191 TODAY</span>';if(diff===1)return lbl+' (tomorrow)';return lbl+` (in ${diff}d)`;}
function deliveryDelta(pkg){if(pkg.status!=='delivered'||!pkg.deliveredAt||!pkg.expectedDate)return'';const diff=Math.round((new Date(pkg.deliveredAt)-new Date(pkg.expectedDate+'T12:00:00'))/86400000);if(diff<0)return`<span class="delivered-delta">\u2713 ${Math.abs(diff)}d early</span>`;if(diff===0)return`<span class="delivered-delta">\u2713 On time</span>`;return`<span style="font-size:9px;color:var(--orange)">\u2191 ${diff}d late</span>`;}
function destInfo(dest){if(!dest)return{cls:'',icon:'',label:''};if(dest==='Drop Ship')return{cls:'dest-dropship',icon:'\u{1F69A}',label:'Drop Ship'};if(dest==='Office')return{cls:'dest-office',icon:'\u{1F3E2}',label:'Office'};return{cls:'dest-custom',icon:'\u{1F4CD}',label:dest};}
function logoImg(c,cls=''){const src=carrierLogos[c];return src?`<img src="${src}" alt="${c}" class="${cls}" onerror="this.style.display='none'">`:''; }
function addSwipe(el,pkgId){let sx=0,sy=0,dx=0,sw=false;el.addEventListener('touchstart',e=>{if(e.target.closest('.card-actions,.timeline,.pkg-checkbox,.card-photos'))return;sx=e.touches[0].clientX;sy=e.touches[0].clientY;sw=false;dx=0;},{passive:true});el.addEventListener('touchmove',e=>{const cx=e.touches[0].clientX,cy=e.touches[0].clientY;dx=cx-sx;if(!sw&&Math.abs(cy-sy)>Math.abs(dx))return;if(Math.abs(dx)>14)sw=true;if(sw){el.style.transform=`translateX(${Math.sign(dx)*Math.min(Math.abs(dx),80)}px)`;el.style.opacity=1-Math.abs(dx)/180;}},{passive:true});el.addEventListener('touchend',()=>{if(!sw){el.style.transform='';el.style.opacity='';return;}el.style.transition='transform .22s,opacity .22s';if(dx>65){el.style.transform='translateX(120px)';el.style.opacity='0';setTimeout(()=>{el.style.transition='';el.style.transform='';el.style.opacity='';updateStatus(pkgId,'delivered');},240);}else if(dx<-65){el.style.transform='translateX(-120px)';el.style.opacity='0';setTimeout(()=>{el.style.transition='';el.style.transform='';el.style.opacity='';archivePackage(pkgId);},240);}else{el.style.transform='';el.style.opacity='';}setTimeout(()=>el.style.transition='',300);sw=false;});}
function renderList(){
  const list=document.getElementById('packageList');
  document.getElementById('countBadge').textContent=packages.length+' TRACKED';
  let f=[...packages];
  if(currentStatusFilter==='__overdue__')f=f.filter(p=>isOverdue(p));
  else if(currentStatusFilter==='__today__')f=f.filter(p=>isToday(p));
  else if(currentStatusFilter!=='all')f=f.filter(p=>p.status===currentStatusFilter);
  if(currentTagFilter)f=f.filter(p=>p.tags&&p.tags.includes(currentTagFilter));
  if(currentCarrierFilter)f=f.filter(p=>p.carrier===currentCarrierFilter);
  if(currentDestFilter)f=f.filter(p=>p.destination===currentDestFilter);
  if(searchQuery)f=f.filter(p=>{const pos=getPOs(p);const hay=[p.name,p.tracking,p.sender,p.notes,...pos,p.carrier,p.destination,...(p.tags||[])].join(' ').toLowerCase();return hay.includes(searchQuery);});
  f=sortPackages(f);
  const q=searchQuery;
  if(!packages.length){list.innerHTML='<div class="empty-state"><div class="icon">\u{1F4E6}</div><h3>No packages yet</h3><p>Use Quick Add above or open the full form.</p></div>';return;}
  if(!f.length){list.innerHTML='<div class="empty-state"><div class="icon">\u{1F50D}</div><h3>No matches</h3><p>Try adjusting your search or filters.</p></div>';return;}
  const showing=(f.length<packages.length)?`<div style="font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px">Showing ${f.length} of ${packages.length}</div>`:'';
  list.innerHTML=showing+f.map(pkg=>{
    const ck=carrierKey[pkg.carrier]||'other',url=trackingUrls[pkg.carrier]&&pkg.tracking?trackingUrls[pkg.carrier]+encodeURIComponent(pkg.tracking):null;
    const di=destInfo(pkg.destination),todayCls=isToday(pkg)?' today-pkg':'',tinted=colorRows?' tinted':'';
    const ovF=isOverdue(pkg)?'<span class="overdue-flag">OVERDUE</span>':'',ddelta=deliveryDelta(pkg);
    const pos=getPOs(pkg);
    const evHtml=pkg.events.map(ev=>`<div class="event-item"><div class="event-time">${fmtDate(ev.time)}</div><div class="event-dot-col"><div class="event-dot dot-${ev.status}"></div><div class="event-line"></div></div><div class="event-content"><div class="event-status-label">${sl(ev.status)}</div><div class="event-location">${ev.location}</div>${ev.note?`<div class="event-note">${ev.note}</div>`:''}</div></div>`).join('');
    const tagsHtml=pkg.tags&&pkg.tags.length?`<div class="card-tags">${pkg.tags.map(t=>`<span class="card-tag">${hl(t,q)}</span>`).join('')}</div>`:'';
    const posHtml=pos.length?`<div class="meta-item">PO <strong>${pos.map(p=>hl(p,q)).join(', ')}</strong></div>`:'';
    const destHtml=pkg.destination?`<span class="dest-badge ${di.cls}">${di.icon} ${di.label}</span>`:'';
    const noteHtml=pkg.noteHistory&&pkg.noteHistory.length?`<div class="note-preview">${pkg.noteHistory.slice(0,2).map(n=>`<div class="note-entry"><span class="note-time">${fmtDate(n.time)}</span><span class="note-text">${n.text}</span></div>`).join('')}</div>`:'';
    const photosHtml=pkg.attachments&&pkg.attachments.length?`<div class="card-photos">${pkg.attachments.map(a=>a.type&&a.type.startsWith('image/')?`<img src="${a.data}" class="card-photo-thumb" onclick="openLightbox('${a.data}')" title="${a.name}">`:`<div style="padding:5px 8px;background:var(--surface2);border:1px solid var(--border);font-size:9px;color:var(--muted)">${a.name}</div>`).join('')}</div>`:'';
    const checked=selectedIds.has(pkg.id)?'checked':'';
    return `<div class="package-card c-${ck}${tinted}${todayCls}" id="pkg-${pkg.id}">
      <div class="card-header" data-id="${pkg.id}" onclick="openModal(this.dataset.id,false)">
        <div class="carrier-logo-stripe">${logoImg(pkg.carrier)}<div class="carrier-abbr">${pkg.carrier}</div></div>
        <div class="card-main">
          <div class="card-top">
            <div style="min-width:0"><div class="package-name">${hl(pkg.name,q)}</div><div class="tracking-num">${hl(pkg.tracking||'No tracking #',q)}</div></div>
            <div style="display:flex;align-items:center;gap:7px;flex-shrink:0"><input type="checkbox" class="pkg-checkbox" ${checked} data-id="${pkg.id}" onclick="event.stopPropagation();toggleSelect(this.dataset.id,this.checked)"><div class="status-pill s-${pkg.status}">${sl(pkg.status)}</div></div>
          </div>
          ${tagsHtml}
          <div class="card-meta">
            ${pkg.sender?`<div class="meta-item">FROM <strong>${hl(pkg.sender,q)}</strong></div>`:''}
            ${posHtml}
            ${pkg.destination?`<div class="meta-item">${destHtml}</div>`:''}
            ${pkg.expectedDate?`<div class="meta-item">ETA <strong>${fmtEta(pkg.expectedDate)}</strong> ${ovF} ${ddelta}</div>`:''}
            ${pkg.deliveredAt&&pkg.status==='delivered'?`<div class="meta-item">DELIVERED <strong>${fmtDate(pkg.deliveredAt)}</strong></div>`:''}
            <div class="meta-item">ADDED <strong>${fmtDate(pkg.addedAt)}</strong></div>
          </div>
          ${noteHtml}
          <button class="timeline-toggle" data-id="${pkg.id}" onclick="event.stopPropagation();toggleTimeline(this.dataset.id)">&#9658; ${pkg.events.length} update${pkg.events.length!==1?'s':''}</button>
        </div>
        <div class="edit-hint">&#9998; tap to edit</div>
      </div>
      ${photosHtml}
      <div class="timeline" id="tl-${pkg.id}">
        <div class="timeline-add">
          <select id="ev-s-${pkg.id}">${Object.keys(defSL).map(k=>`<option value="${k}"${k==='transit'?' selected':''}>${sl(k)}</option>`).join('')}</select>
          <input type="text" id="ev-l-${pkg.id}" placeholder="Location / facility...">
          <input type="text" id="ev-n-${pkg.id}" placeholder="Note (optional)">
          <button class="btn-sm" data-id="${pkg.id}" onclick="addEvent(this.dataset.id)">LOG</button>
        </div>
        <div class="events-list">${evHtml}</div>
      </div>
      <div class="card-actions" onclick="event.stopPropagation()">
        <button class="action-btn" data-id="${pkg.id}" data-action="transit" onclick="updateStatus(this.dataset.id,'transit')">In Transit</button>
        <button class="action-btn" data-id="${pkg.id}" data-action="outdelivery" onclick="updateStatus(this.dataset.id,'outdelivery')">Out for Del.</button>
        <button class="action-btn" data-id="${pkg.id}" onclick="updateStatus(this.dataset.id,'delivered')">&#10003; Delivered</button>
        <button class="action-btn dup" data-id="${pkg.id}" onclick="duplicatePackage(this.dataset.id)">&#8664; Dup</button>
        <button class="action-btn arch" data-id="${pkg.id}" onclick="archivePackage(this.dataset.id)">&#128193; Archive</button>
        <button class="action-btn del" data-id="${pkg.id}" onclick="deletePackage(this.dataset.id)">&#128465; Delete</button>
        ${url?`<a class="track-link" href="${url}" target="_blank" rel="noopener">Track on ${pkg.carrier} &rarr;</a>`:''}
      </div>
    </div>`;
  }).join('');
  f.forEach(pkg=>{const el=document.getElementById('pkg-'+pkg.id);if(el)addSwipe(el,pkg.id);});
}
function renderHistory(){
  const list=document.getElementById('historyList');
  if(!archived.length){list.innerHTML='<div class="empty-state"><div class="icon">\u{1F5C2}</div><h3>No archived packages</h3><p>Archive active packages to store them here.</p></div>';return;}
  list.innerHTML=archived.map(pkg=>{
    const ck=carrierKey[pkg.carrier]||'other',url=trackingUrls[pkg.carrier]&&pkg.tracking?trackingUrls[pkg.carrier]+encodeURIComponent(pkg.tracking):null;
    const di=destInfo(pkg.destination),tagsHtml=pkg.tags&&pkg.tags.length?`<div class="card-tags">${pkg.tags.map(t=>`<span class="card-tag">${t}</span>`).join('')}</div>`:'';
    const destHtml=pkg.destination?`<span class="dest-badge ${di.cls}">${di.icon} ${di.label}</span>`:'';
    return`<div class="package-card archived c-${ck}"><div class="archived-when">\u{1F5C2} Archived ${fmtDate(pkg.archivedAt)}</div>
      <div class="card-header" data-id="${pkg.id}" onclick="openModal(this.dataset.id,true)"><div class="carrier-logo-stripe">${logoImg(pkg.carrier)}<div class="carrier-abbr">${pkg.carrier}</div></div>
        <div class="card-main"><div class="card-top"><div style="min-width:0"><div class="package-name">${pkg.name}</div><div class="tracking-num">${pkg.tracking||'No tracking #'}</div></div><div class="status-pill s-${pkg.status}">${sl(pkg.status)}</div></div>
          ${tagsHtml}<div class="card-meta">${pkg.sender?`<div class="meta-item">FROM <strong>${pkg.sender}</strong></div>`:''}${pkg.destination?`<div class="meta-item">${destHtml}</div>`:''}${pkg.expectedDate?`<div class="meta-item">ETA <strong>${fmtEta(pkg.expectedDate)}</strong></div>`:''}
          <div class="meta-item">ADDED <strong>${fmtDate(pkg.addedAt)}</strong></div></div></div><div class="edit-hint">&#9998; edit</div></div>
      <div class="card-actions"><button class="action-btn restore" data-id="${pkg.id}" onclick="restorePackage(this.dataset.id)">&#8617; Restore</button><button class="action-btn perm-del" data-id="${pkg.id}" onclick="deleteArchived(this.dataset.id)">&#128465; Delete Forever</button>${url?`<a class="track-link" href="${url}" target="_blank" rel="noopener">Track &rarr;</a>`:''}</div></div>`;
  }).join('');
}
function openModal(pkgId,fromArchive){
  const list=fromArchive?archived:packages,pkg=list.find(p=>p.id===pkgId);if(!pkg)return;
  document.getElementById('editId').value=pkgId;
  document.getElementById('editIsArchived').value=fromArchive?'1':'';
  document.getElementById('editName').value=pkg.name||'';
  document.getElementById('editTracking').value=pkg.tracking||'';
  document.getElementById('editSender').value=pkg.sender||'';
  bDS('editDestination',pkg.destination||'');
  bSS('editStatus',pkg.status||'pending');
  editCarrier=pkg.carrier||'Other';
  document.querySelectorAll('#editCarrierGrid .carrier-btn').forEach(b=>b.classList.toggle('selected',b.dataset.carrier===editCarrier));
  editTagsSel=[...(pkg.tags||[])];renderEditTags();
  editPOs=[...getPOs(pkg)];rPOC('editPOChips',editPOs,'edit');
  editAttachments=JSON.parse(JSON.stringify(pkg.attachments||[]));rPP('editPhotoPreview',editAttachments,'edit');
  rNH(pkg);
  document.getElementById('editOverlay').classList.add('open');document.body.style.overflow='hidden';
  requestAnimationFrame(()=>{document.getElementById('editExpected').value=pkg.expectedDate||'';});
}
function closeModal(){document.getElementById('editOverlay').classList.remove('open');document.body.style.overflow='';}
function saveEdit(){
  const pkgId=document.getElementById('editId').value,fa=document.getElementById('editIsArchived').value==='1',list=fa?archived:packages,pkg=list.find(p=>p.id===pkgId);if(!pkg)return;
  const poInp=document.getElementById('editPO').value.trim();if(poInp&&!editPOs.includes(poInp))editPOs.push(poInp);
  const oldStatus=pkg.status;
  pkg.name=document.getElementById('editName').value.trim();
  pkg.tracking=document.getElementById('editTracking').value.trim();
  pkg.carrier=editCarrier;
  pkg.sender=document.getElementById('editSender').value.trim();
  pkg.destination=document.getElementById('editDestination').value;
  pkg.expectedDate=document.getElementById('editExpected').value;
  pkg.status=document.getElementById('editStatus').value;
  pkg.pos=[...editPOs];
  pkg.tags=[...editTagsSel];
  pkg.attachments=JSON.parse(JSON.stringify(editAttachments));
  if(pkg.status!==oldStatus){if(pkg.status==='delivered'&&!pkg.deliveredAt)pkg.deliveredAt=new Date().toISOString();pkg.events.unshift({id:Date.now().toString(),status:pkg.status,location:pkg.destination||'—',note:'Edited',time:new Date().toISOString()});}
  save();closeModal();renderList();renderCalendar();renderHistory();updateStats();
}
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
function calShift(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}if(calMonth<0){calMonth=11;calYear--;}renderCalendar();}
function renderCalendar(){
  document.getElementById('calTitle').textContent=MONTHS[calMonth]+' '+calYear;
  const grid=document.getElementById('calGrid'),today=new Date();
  const daysInM=new Date(calYear,calMonth+1,0).getDate(),startDay=new Date(calYear,calMonth,1).getDay();
  const byDate={};packages.forEach(pkg=>{if(!pkg.expectedDate)return;(byDate[pkg.expectedDate]=byDate[pkg.expectedDate]||[]).push(pkg);});
  let html=DAYS.map(d=>`<div class="cal-day-header">${d}</div>`).join('');
  for(let i=0;i<startDay;i++){const d=new Date(calYear,calMonth,1-startDay+i);html+=`<div class="cal-cell other-month"><div class="cal-day-num">${d.getDate()}</div></div>`;}
  for(let d=1;d<=daysInM;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday2=today.getFullYear()===calYear&&today.getMonth()===calMonth&&today.getDate()===d;
    const chips=(byDate[ds]||[]).map(pkg=>`<div class="cal-pkg s-${pkg.status}${isToday2?' today-cal':''}" data-pkgid="${pkg.id}" draggable="true" ondragstart="calDragStart(event,'${pkg.id}')" ontouchstart="calTouchStart(event,'${pkg.id}')" title="${pkg.name}" data-id="${pkg.id}" onclick="openModal(this.dataset.id,false)"><div class="cal-pkg-name">${pkg.name}</div><div style="font-size:8px;opacity:.7">${pkg.carrier} · ${sl(pkg.status)}</div></div>`).join('');
    html+=`<div class="cal-cell${isToday2?' today':''}" data-date="${ds}" ondragover="calDragOver(event)" ondragleave="calDragLeave(event)" ondrop="calDrop(event,'${ds}')"><div class="cal-day-num">${d}</div>${chips}</div>`;
  }
  const rem=(7-((startDay+daysInM)%7))%7;
  for(let i=1;i<=rem;i++)html+=`<div class="cal-cell other-month"><div class="cal-day-num">${i}</div></div>`;
  grid.innerHTML=html;
}
let dragPkgId=null,touchClone=null,lastDropCell=null;
function calDragStart(e,pkgId){dragPkgId=pkgId;e.dataTransfer.setData('pkgId',pkgId);e.dataTransfer.effectAllowed='move';setTimeout(()=>{const el=document.querySelector(`.cal-pkg[data-pkgid="${pkgId}"]`);if(el)el.classList.add('dragging');},0);}
function calDragOver(e){e.preventDefault();e.dataTransfer.dropEffect='move';if(!e.currentTarget.classList.contains('other-month'))e.currentTarget.classList.add('drag-over');}
function calDragLeave(e){e.currentTarget.classList.remove('drag-over');}
function calDrop(e,ds){e.preventDefault();e.currentTarget.classList.remove('drag-over');document.querySelectorAll('.cal-pkg.dragging').forEach(el=>el.classList.remove('dragging'));const pkgId=e.dataTransfer.getData('pkgId')||dragPkgId;if(!pkgId)return;const pkg=packages.find(p=>p.id===pkgId);if(!pkg)return;pkg.expectedDate=ds;dragPkgId=null;save();renderCalendar();renderList();}
function calTouchStart(e,pkgId){dragPkgId=pkgId;const touch=e.touches[0],srcEl=e.currentTarget,srcRect=srcEl.getBoundingClientRect(),offsetX=touch.clientX-srcRect.left,offsetY=touch.clientY-srcRect.top;touchClone=srcEl.cloneNode(true);touchClone.classList.add('touch-dragging-clone');touchClone.style.width=srcRect.width+'px';touchClone.style.left=(touch.clientX-offsetX)+'px';touchClone.style.top=(touch.clientY-offsetY)+'px';document.body.appendChild(touchClone);srcEl.classList.add('dragging');function onTouchMove(e){e.preventDefault();const t=e.touches[0];touchClone.style.left=(t.clientX-offsetX)+'px';touchClone.style.top=(t.clientY-offsetY)+'px';touchClone.style.display='none';const elUnder=document.elementFromPoint(t.clientX,t.clientY);touchClone.style.display='';const cell=elUnder?elUnder.closest('.cal-cell'):null;if(lastDropCell&&lastDropCell!==cell)lastDropCell.classList.remove('drag-over');if(cell&&!cell.classList.contains('other-month')){cell.classList.add('drag-over');lastDropCell=cell;}else lastDropCell=null;}function onTouchEnd(){if(touchClone){touchClone.remove();touchClone=null;}document.querySelectorAll('.cal-pkg.dragging').forEach(el=>el.classList.remove('dragging'));if(lastDropCell){lastDropCell.classList.remove('drag-over');const pkg=packages.find(p=>p.id===dragPkgId);if(pkg&&lastDropCell.dataset.date){pkg.expectedDate=lastDropCell.dataset.date;save();renderCalendar();renderList();}}dragPkgId=null;lastDropCell=null;document.removeEventListener('touchmove',onTouchMove);document.removeEventListener('touchend',onTouchEnd);}document.addEventListener('touchmove',onTouchMove,{passive:false});document.addEventListener('touchend',onTouchEnd);}
function switchView(view,el){document.querySelectorAll('.main-tab').forEach(b=>b.classList.remove('active'));el.classList.add('active');document.getElementById('pkgView').style.display=view==='packages'?'block':'none';document.getElementById('calView').style.display=view==='calendar'?'block':'none';document.getElementById('historyView').style.display=view==='history'?'block':'none';if(view==='calendar')renderCalendar();if(view==='history')renderHistory();}
let scanStream=null,scanFrame=null;
let scannerTargetField=null;
function openScanner(targetFieldId){
  scannerTargetField=targetFieldId||null;
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    alert('Camera not supported on this browser/device. Try Chrome on Android or Safari on iOS.');return;
  }
  document.getElementById('scanOverlay').classList.add('open');
  document.getElementById('scanStatus').textContent='Starting camera…';
  navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}})
  .then(stream=>{
    scanStream=stream;
    const video=document.getElementById('scanVideo');
    video.srcObject=stream;
    video.play();
    document.getElementById('scanStatus').textContent='Point at a barcode…';
    if('BarcodeDetector' in window){
      const bd=new BarcodeDetector({formats:['code_128','code_39','code_93','qr_code','ean_13','ean_8','upc_a','upc_e','itf','data_matrix']});
      function scan(){
        bd.detect(video).then(barcodes=>{
          if(barcodes.length){
            const code=barcodes[0].rawValue;
            closeScanner();
            // Fill whichever field triggered the scan
            if(scannerTargetField==='qa'){
              document.getElementById('qaTracking').value=code;
              qaDetect(code);
              document.getElementById('qaName').focus();
            } else {
              document.getElementById('trackNum').value=code;
              detectCarrier(code);
              document.getElementById('pkgName').focus();
            }
            scannerTargetField=null;
          } else {
            scanFrame=requestAnimationFrame(scan);
          }
        }).catch(()=>{scanFrame=requestAnimationFrame(scan);});
      }
      video.onloadedmetadata=()=>{scanFrame=requestAnimationFrame(scan);};
    } else {
      // Fallback: manual entry prompt
      document.getElementById('scanStatus').textContent='Live scan not available — tap Cancel and type tracking number';
    }
  })
  .catch(err=>{
    document.getElementById('scanStatus').textContent='Camera error: '+err.message+'. Check browser permissions.';
  });
}
function closeScanner(){
  document.getElementById('scanOverlay').classList.remove('open');
  if(scanFrame){cancelAnimationFrame(scanFrame);scanFrame=null;}
  if(scanStream){scanStream.getTracks().forEach(t=>t.stop());scanStream=null;}
}
function openSettings(){rebuildAll();renderDestList();document.getElementById('overdueThreshInput').value=overdueThresh;updateNotifUI();document.getElementById('settingsOverlay').classList.add('open');document.body.style.overflow='hidden';}
function closeSettings(){document.getElementById('settingsOverlay').classList.remove('open');document.body.style.overflow='';}
function saveOverdueThresh(){const v=parseInt(document.getElementById('overdueThreshInput').value)||0;overdueThresh=Math.max(0,v);localStorage.setItem('trackOverdueThresh',overdueThresh);updateStats();}
function addDest(){const inp=document.getElementById('newDestInput'),v=inp.value.trim();if(!v)return;if(!customDests.includes(v))customDests.push(v);inp.value='';save();renderDestList();rebuildAll();}
function removeDest(d){customDests=customDests.filter(x=>x!==d);save();renderDestList();rebuildAll();}
function renderDestList(){const el=document.getElementById('destList');if(!el)return;el.innerHTML=customDests.map(d=>`<div class="dest-item"><span class="dest-item-name">${d}</span><button class="dest-del" data-dest="${d}" onclick="removeDest(this.dataset.dest)">&#10005;</button></div>`).join('');}
function saveStatusLabels(){Object.keys(defSL).forEach(k=>{const inp=document.getElementById('slbl_'+k);if(inp)customStatusLabels[k]=inp.value.trim();});save();rebuildAll();renderList();}
function requestNotif(){if(!('Notification' in window)){alert('Notifications not supported.');return;}Notification.requestPermission().then(p=>{if(p==='granted'){localStorage.setItem('trackNotif','1');updateNotifUI();}});}
function updateNotifUI(){const granted=Notification.permission==='granted';document.getElementById('notifDot').className='notif-dot '+(granted?'on':'off');document.getElementById('notifLabel').textContent=granted?'Push notifications enabled — overdue alerts active':'Get overdue alerts in your browser';document.getElementById('notifBtn').textContent=granted?'Enabled \u2713':'Enable';}
function openTemplates(){renderTemplateList();document.getElementById('templatesOverlay').classList.add('open');document.body.style.overflow='hidden';}
function closeTemplates(){document.getElementById('templatesOverlay').classList.remove('open');document.body.style.overflow='';}
function saveTemplate(){const name=document.getElementById('tplNameInput').value.trim();if(!name){alert('Enter a name.');return;}templates.push({id:Date.now().toString(),name,carrier:selectedCarrier||'Other',destination:document.getElementById('destination').value,tags:[...selectedFormTags],status:document.getElementById('initStatus').value});save();renderTemplateList();document.getElementById('tplNameInput').value='';}
function applyTemplate(id){const t=templates.find(x=>x.id===id);if(!t)return;selectedCarrier=t.carrier||'Other';document.querySelectorAll('#carrierGrid .carrier-btn').forEach(b=>b.classList.toggle('selected',b.dataset.carrier===selectedCarrier));bDS('destination',t.destination||'');bSS('initStatus',t.status||'pending');selectedFormTags=[...(t.tags||[])];renderFormTags();closeTemplates();if(!document.getElementById('addForm').classList.contains('open'))toggleAddForm();document.getElementById('pkgName').focus();}
function deleteTemplate(id){templates=templates.filter(t=>t.id!==id);save();renderTemplateList();}
function renderTemplateList(){const el=document.getElementById('templateList');if(!templates.length){el.innerHTML='<div style="font-size:11px;color:var(--muted);padding:8px 0">No templates yet — fill the form and save one above.</div>';return;}el.innerHTML=templates.map(t=>`<div class="template-item" data-id="${t.id}" onclick="applyTemplate(this.dataset.id)"><div><div class="template-name">${t.name}</div><div class="template-meta">${t.carrier} \u00b7 ${t.destination||'no dest'} \u00b7 ${(t.tags||[]).join(', ')||'no tags'}</div></div><button class="template-del" data-id="${t.id}" onclick="event.stopPropagation();deleteTemplate(this.dataset.id)">&#10005;</button></div>`).join('');}
let scriptUrl=localStorage.getItem('trackScriptUrl')||'';
let syncInFlight=false;
let lastKnownRemoteTs=parseInt(localStorage.getItem('trackRemoteTs')||'0',10);
let autoPushTimer=null;
let autoPollTimer=null;

function setSyncStatus(state,text){
  document.getElementById('syncDot').className='sync-dot '+state;
  document.getElementById('syncStatusText').textContent=text;
  const en=!!scriptUrl&&!syncInFlight;
  document.getElementById('syncNowBtn').disabled=!en;
  document.getElementById('syncPullBtn').disabled=!en;
  document.getElementById('syncPushBtn').disabled=!en;
}
// Sync Now: push local data then immediately pull to get remote changes
async function syncNow(){
  if(!scriptUrl||syncInFlight)return;
  setSyncStatus('syncing','Syncing…');
  // First push our local data
  await syncPush(false);
  // Then pull to get any changes from other devices
  await syncPull(false,true);
  const t=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  setSyncStatus('ok','Synced at '+t+' ↑↓');
}
function initSyncUI(){
  if(scriptUrl){
    setSyncStatus('off','Sheets connected');
    document.getElementById('syncNowBtn').disabled=false;
    document.getElementById('syncPullBtn').disabled=false;
    document.getElementById('syncPushBtn').disabled=false;
    document.getElementById('scriptUrlInput').value=scriptUrl;
    // Auto-pull on load to get latest data from other devices
    setTimeout(()=>syncPull(false),1500);
    // Poll every 60s for changes from other devices
    startAutoPoll();
  } else {
    setSyncStatus('off','Google Sheets not configured');
  }
}
function startAutoPoll(){
  clearInterval(autoPollTimer);
  if(!scriptUrl)return;
  autoPollTimer=setInterval(()=>syncPull(false),60000);
}
function toggleSyncPanel(){document.getElementById('syncPanel').classList.toggle('open');}
function saveScriptUrl(){
  const url=document.getElementById('scriptUrlInput').value.trim();
  if(!url||!url.startsWith('https://script.google.com')){alert('Enter a valid Apps Script URL.');return;}
  scriptUrl=url;
  localStorage.setItem('trackScriptUrl',scriptUrl);
  document.getElementById('syncPanel').classList.remove('open');
  setSyncStatus('off','URL saved — pulling data...');
  document.getElementById('syncNowBtn').disabled=false;
  document.getElementById('syncPullBtn').disabled=false;
  document.getElementById('syncPushBtn').disabled=false;
  setTimeout(()=>syncPull(false),500);
  startAutoPoll();
}
function clearScriptUrl(){
  if(!confirm('Remove Sheets connection?'))return;
  scriptUrl='';
  localStorage.removeItem('trackScriptUrl');
  localStorage.removeItem('trackRemoteTs');
  document.getElementById('scriptUrlInput').value='';
  clearInterval(autoPollTimer);
  setSyncStatus('off','Google Sheets not configured');
  document.getElementById('syncNowBtn').disabled=true;
  document.getElementById('syncPullBtn').disabled=true;
  document.getElementById('syncPushBtn').disabled=true;
}
function copyGasCode(){navigator.clipboard.writeText(document.getElementById('gasCode').textContent).then(()=>{const btn=document.querySelector('.copy-code-btn');btn.textContent='\u2713 Copied!';setTimeout(()=>btn.textContent='\u{1F4CB} Copy Script',2000);});}

// PUSH — uses POST so there's no URL length limit (GET breaks with attachments/large data)
async function syncPush(manual=false){
  if(!scriptUrl||syncInFlight)return;
  syncInFlight=true;
  if(manual)setSyncStatus('syncing','Pushing to Sheets...');
  try{
    const payload=JSON.stringify({packages,tags:allTags,customDests,customStatusLabels,templates});
    const resp=await fetch(scriptUrl,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:payload
    });
    const data=await resp.json();
    if(data.ok){
      const t=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
      // After push, set remote ts so we know what's on the sheet
      lastKnownRemoteTs=data.ts||Date.now();
      localStorage.setItem('trackRemoteTs',lastKnownRemoteTs);
      setSyncStatus('ok',`Pushed ${data.saved} pkg${data.saved!==1?'s':''} at ${t}`);
    } else {
      setSyncStatus('err','Push failed: '+(data.error||'Unknown'));
    }
  } catch(e){
    setSyncStatus('err','Push error: '+e.message);
  }
  syncInFlight=false;
}

// PULL — uses GET, merges by timestamp (no confirmation dialog)
async function syncPull(manual=false,forceApply=false){
  if(!scriptUrl||syncInFlight)return;
  syncInFlight=true;
  if(manual)setSyncStatus('syncing','Pulling from Sheets...');
  try{
    const resp=await fetch(scriptUrl+'?nocache='+Date.now());
    const data=await resp.json();
    if(data.ok){
      const remoteTs=data.ts||0;
      const hasData=data.packages&&data.packages.length>0;
      if(!hasData){
        if(manual)setSyncStatus('ok','Sheets is empty');
        syncInFlight=false;return;
      }
      // Only apply if remote is newer than what we last pushed
      if(remoteTs>lastKnownRemoteTs||manual||forceApply){
        packages=data.packages;
        if(data.tags&&data.tags.length)allTags=data.tags;
        if(data.customDests&&data.customDests.length)customDests=data.customDests;
        if(data.customStatusLabels&&Object.keys(data.customStatusLabels).length)customStatusLabels=data.customStatusLabels;
        if(data.templates&&data.templates.length)templates=data.templates;
        // Save locally WITHOUT triggering auto-push (avoid loop)
        localStorage.setItem('trackPackages',JSON.stringify(packages));
        localStorage.setItem('trackArchived',JSON.stringify(archived));
        localStorage.setItem('trackTags',JSON.stringify(allTags));
        localStorage.setItem('trackDests',JSON.stringify(customDests));
        localStorage.setItem('trackStatusLabels',JSON.stringify(customStatusLabels));
        localStorage.setItem('trackTemplates',JSON.stringify(templates));
        lastKnownRemoteTs=remoteTs;
        localStorage.setItem('trackRemoteTs',remoteTs);
        rebuildAll();renderFormTags();renderTagFilters();renderList();renderCalendar();updateStats();
        const t=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
        setSyncStatus('ok',`Synced ${packages.length} pkg${packages.length!==1?'s':''} at ${t} \u2193`);
      } else {
        if(manual){const t=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});setSyncStatus('ok',`Up to date at ${t}`);}
        else setSyncStatus('ok',document.getElementById('syncStatusText').textContent);
      }
    } else {
      if(manual)setSyncStatus('err','Pull failed: '+(data.error||'Unknown'));
    }
  } catch(e){
    if(manual)setSyncStatus('err','Pull error: '+e.message);
  }
  syncInFlight=false;
}

// Override save() to auto-push 2s after any local change
const _origSave=save;
save=function(){
  _origSave();
  if(!scriptUrl)return;
  clearTimeout(autoPushTimer);
  document.getElementById('syncAutoLabel').textContent='Saving...';
  autoPushTimer=setTimeout(()=>syncPush(false),2000);
};
if('serviceWorker' in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
rebuildAll();
renderFormTags();
renderTagFilters();
renderList();
updateStats();
updateHistoryBadge();
initSyncUI();
updateNotifUI();
</script>
</body>
</html>
